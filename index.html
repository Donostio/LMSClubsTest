<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Clubs</title>
    <link rel="icon" type="image/png" href="lms_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #000;
            background-image: repeating-linear-gradient(to right, #ef4444, #ef4444 2px, #000 2px, #000 24px);
        }
        .filter-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .filter-panel.is-active {
            transform: translateX(0);
        }
        .backdrop {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .backdrop.is-active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Cat CSS (left exactly as in your original) */
.cat-container {
  position: fixed;
  z-index: 100;
  pointer-events: none;
  will-change: transform;
}
.cat-container.from-top {
  top: 0;
  left: 50%;
  transform: translate(-50%, -100vh);
  transition: transform 0.8s ease-out;
}
.cat-container.from-top.is-active {
  transform: translate(-50%, 0);
}
.cat-container.from-right {
  top: 50%;
  right: 0;
  transform: translate(100vw, -50%);
  transition: transform 0.8s ease-out;
}
.cat-container.from-right.is-active {
  transform: translate(0, -50%);
}
.cat-container.from-bottom {
  bottom: 0;
  left: 50%;
  transform: translate(-50%, 100vh);
  transition: transform 0.8s ease-out;
}
.cat-container.from-bottom.is-active {
  transform: translate(-50%, 0);
}
.cat-container.from-left {
  top: 50%;
  left: 0;
  transform: translate(-100vw, -50%);
  transition: transform 0.8s ease-out;
}
.cat-container.from-left.is-active {
  transform: translate(0, -50%);
}
.cat-container.ascending-cat {
  bottom: 0;
  left: 50%;
  transform: translate(-50%, 100%);
  transition: none;
}
.cat-container.ascending-cat.is-active {
  transform: translate(-50%, -66.6666%);
  transition: transform 3s ease-out;
}
.cat-container.ascending-cat.slide-down {
  transform: translate(-50%, 100%);
  transition: transform 0.5s ease-in;
}
.cat-container img {
  width: 150px;
  height: auto;
  border-radius: 0.75rem;
}
.cat-container.ascending-cat img {
  transform: scale(4);
}

/* Club selection styling */
.club-selected {
    box-shadow: 0 0 0 3px rgba(0,0,0,1), 0 0 0 6px rgba(239,68,68,0.95);
    border: 2px solid rgba(239,68,68,0.9);
}
.club-select-box {
    position: absolute;
    right: 12px;
    bottom: 12px;
}

/* Floating print control */
#floating-print-controls {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 120;
    display: flex;
    align-items: center;
    gap: 10px;
}
#floating-print-controls.hidden { display: none; }
#print-my-btn, #print-personal-btn {
    background: linear-gradient(90deg, #ef4444, #000);
    color: white;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
}
#print-year-btn {
    margin-left: 8px;
    background: #111827;
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
}

/* Year select smaller and All option red */
#year-filter { width: 140px; }
#year-filter option[value=""] { color: #ef4444; font-weight:700; }

/* Print-friendly defaults (in-page). The actual print window will receive more CSS. */
@media print {
    #filter-panel, #filter-btn, #search-input, #floating-print-controls, .filter-overlay { display: none !important; }
}
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <!-- Cat container (left untouched) -->
    <div id="cat-container" class="cat-container">
        <div id="cat-wrapper" class="cat-wrapper">
            <img id="cat-image" src="" alt="" class="cat-image">
        </div>
    </div>

    <div class="relative w-full max-w-2xl mx-auto flex flex-col p-4 sm:p-6 bg-white rounded-b-3xl shadow-lg">

        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold text-gray-800">LMS TEST Clubs 2025-26</h1>
            <button id="filter-btn" class="p-2 bg-purple-600 text-white rounded-full shadow-md hover:bg-purple-700 transition-colors duration-200" aria-controls="filter-panel" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 12H7.5" />
                </svg>
            </button>
        </div>

        <div id="active-filters-summary" class="text-sm text-gray-500 mb-4 transition-all duration-300"></div>

        <div class="relative mb-6 flex items-start gap-4">
            <div>
                <label for="year-filter" class="block text-gray-700 font-medium mb-1">Year Group</label>
                <select id="year-filter" class="p-2 rounded-xl border-2 border-gray-200">
                    <option value="">All</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                </select>
                <p id="year-helper" class="helper-small mt-1 text-gray-500">Select a year to enable club selection & printing</p>

                <!-- Buttons outside filter -->
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                    <button id="print-my-btn" style="display:none;">Print My Timetable</button>
                    <button id="print-personal-btn" style="display:none; background:#111827;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">Personal selected-clubs timetable</button>
                    <label style="font-size:13px;color:#6b7280;display:flex;align-items:center;gap:6px;margin-left:6px;">
                        <input id="include-other-clubs-inline" type="checkbox" /> Also include other available clubs (small)
                    </label>
                </div>
            </div>

            <div style="flex:1">
                <label class="block text-gray-700 font-medium mb-1">Search</label>
                <input type="text" id="search-input" placeholder="Search for a club..." class="w-full pl-3 pr-4 py-2 rounded-xl text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors border-2 border-gray-200">
            </div>
        </div>

        <div id="filter-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 backdrop-blur-sm backdrop hidden"></div>

        <div id="filter-panel" class="fixed right-0 top-0 h-full w-full max-w-sm bg-white shadow-xl z-50 p-6 flex flex-col filter-panel" aria-hidden="true">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Filters</h2>
                <button id="close-filter-btn" class="p-2 text-gray-500 rounded-full hover:bg-gray-100 transition-colors duration-200" aria-label="Close filters">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="space-y-6 mb-8 overflow-y-auto">
                <div>
                    <div class="flex items-center justify-between">
                        <label for="year-filter-panel" class="block text-gray-700 font-medium mb-1">Year Group</label>
                        <button id="clear-year-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
                    </div>
                    <select id="year-filter-panel" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                        <option value="">All</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                    </select>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-medium mb-2">Day</label>
                        <button id="clear-day-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
                    </div>
                    <div id="day-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200"></div>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-medium mb-2">When</label>
                        <button id="clear-when-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
                    </div>
                    <div id="when-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200"></div>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label for="department-filter" class="block text-gray-700 font-medium mb-1">Department</label>
                        <button id="clear-department-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
                    </div>
                    <select id="department-filter" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                        <option value="">All</option>
                        <option value="ART">ART</option>
                        <option value="CS">CS</option>
                        <option value="Drama">Drama</option>
                        <option value="DT">DT</option>
                        <option value="English">English</option>
                        <option value="Maths">Maths</option>
                        <option value="Music">Music</option>
                        <option value="Other">Other</option>
                        <option value="Pastoral">Pastoral</option>
                        <option value="PE">PE</option>
                        <option value="RS">RS</option>
                        <option value="Science">Science</option>
                        <option value="SEN">SEN</option>
                    </select>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-medium mb-2">Club Name</label>
                        <button id="clear-club-name-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
                    </div>
                    <div id="club-name-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200 max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <button id="clear-filters-btn" class="w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-colors duration-200 mt-auto">Clear All Filters</button>
        </div>

        <div id="clubs-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

        <div id="loading-message" class="text-center text-gray-500 py-12 hidden">
            <svg class="animate-spin h-8 w-8 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.96l2-2.669z"></path>
            </svg>
            <p class="mt-4 text-xl font-medium">Loading clubs data...</p>
        </div>

        <div id="no-results" class="hidden text-center text-gray-500 py-12">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 text-gray-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>
            <p class="text-xl font-medium">No clubs found matching your criteria.</p>
        </div>

        <div class="text-center text-xs text-gray-400 mt-8">
            <p>This site is maintained by LMS class reps🚀</p> 
            <p>Your feedback helps us make the site better for everyone. <a href="https://forms.gle/5Gdrj6RPAEXf7jKy8" target="_blank" rel="noopener noreferrer" class="text-purple-600 hover:text-purple-800 transition-colors duration-200">Please share your thoughts here 💬</a><p>
        </div>
    </div>

    <!-- Hidden iframe used for printing (no popups) -->
    <iframe id="print-iframe" style="display:none;"></iframe>

    <script>
        /**************************************************************************
         * Kept the cat animation code exactly as it was in your original file.
         * (No modifications.)
         **************************************************************************/
        const catImages = [
            'images/1C.png',
            'images/2C.png',
            'images/3.png'
        ];
        const catContainer = document.getElementById('cat-container');
        const catImageElement = document.getElementById('cat-image');
        const catWrapper = document.getElementById('cat-wrapper');
        let interactionCount = 0;
        const catIntervalMin = 10;
        const catIntervalMax = 50;
        let nextCatInteraction = Math.floor(Math.random() * (catIntervalMax - catIntervalMin + 1)) + catIntervalMin;

        const showCat = () => {
            console.log("showCat() is being called. A cat should be appearing!");
            const catIndex = Math.floor(Math.random() * catImages.length);
            const selectedCatImage = catImages[catIndex];

            catContainer.classList.remove('is-active', 'from-top', 'from-right', 'from-bottom', 'from-left', 'ascending-cat', 'slide-down');
            catContainer.style.transform = '';
            catImageElement.style.transform = '';

            const animations = ['from-top', 'from-right', 'from-bottom', 'from-left', 'ascending-cat'];
            const chosenAnimation = animations[Math.floor(Math.random() * animations.length)];

            if (chosenAnimation === 'ascending-cat') {
                catImageElement.src = selectedCatImage;
                catContainer.className = 'cat-container';
                catContainer.style.cssText = '';
                catImageElement.style.cssText = '';
                catContainer.style.position = 'fixed';
                catContainer.style.bottom = '0';
                catContainer.style.left = '50%';
                catContainer.style.transform = 'translate(-50%, 100%)';
                catContainer.style.zIndex = '100';
                catContainer.style.pointerEvents = 'none';
                catContainer.style.transition = 'none';
                catContainer.style.overflow = 'hidden';
                catImageElement.style.width = '600px';
                catImageElement.style.height = 'auto';
                catImageElement.style.borderRadius = '0.75rem';
                catImageElement.style.display = 'block';
                catContainer.offsetHeight;
                setTimeout(() => {
                    catContainer.style.transition = 'transform 0.4s ease-out';
                    catContainer.style.transform = 'translate(-50%, 35%)';
                    setTimeout(() => {
                        catContainer.style.transition = 'transform 3s ease-in';
                        catContainer.style.transform = 'translate(-50%, 100%)';
                        setTimeout(() => {
                            catContainer.style.display = 'none';
                            catContainer.style.visibility = 'hidden';
                            catContainer.style.opacity = '0';
                            catContainer.style.zIndex = '-999';
                            catContainer.style.transform = 'translate(-50%, 200vh)';
                            setTimeout(() => {
                                catContainer.className = 'cat-container';
                                catContainer.style.cssText = '';
                                catImageElement.style.cssText = '';
                                catImageElement.src = '';
                            }, 200);
                        }, 3000);
                    }, 900);
                }, 100);
            } else {
                catImageElement.src = selectedCatImage;
                catContainer.classList.add(chosenAnimation);
                setTimeout(() => {
                    catContainer.classList.add('is-active');
                }, 50);

                setTimeout(() => {
                    catContainer.classList.remove('is-active');
                }, 2000);
            }
        };

        const handleInteraction = () => {
            interactionCount++;
            console.log(`Interaction detected. Current count: ${interactionCount}. Next cat at: ${nextCatInteraction}`);
            if (interactionCount >= nextCatInteraction) {
                showCat();
                interactionCount = 0;
                nextCatInteraction = Math.floor(Math.random() * (catIntervalMax - catIntervalMin + 1)) + catIntervalMin;
            }
        };

        // Keep test call as in original (you had this present)
        const showAscendingCatForTesting = () => {
            const catIndex = Math.floor(Math.random() * catImages.length);
            const selectedCatImage = catImages[catIndex];

            catContainer.className = 'cat-container';
            catContainer.style.cssText = '';
            catImageElement.style.cssText = '';
            catContainer.style.position = 'fixed';
            catContainer.style.bottom = '0';
            catContainer.style.left = '50%';
            catContainer.style.transform = 'translate(-50%, 100%)';
            catContainer.style.zIndex = '100';
            catContainer.style.pointerEvents = 'none';
            catContainer.style.transition = 'none';
            catContainer.style.overflow = 'hidden';
            catImageElement.src = selectedCatImage;
            catImageElement.style.width = '600px';
            catImageElement.style.height = 'auto';
            catImageElement.style.borderRadius = '0.75rem';
            catImageElement.style.display = 'block';
            catContainer.offsetHeight;
            setTimeout(() => {
                catContainer.style.transition = 'transform 0.4s ease-out';
                catContainer.style.transform = 'translate(-50%, 35%)';
                setTimeout(() => {
                    catContainer.style.transition = 'transform 3s ease-in';
                    catContainer.style.transform = 'translate(-50%, 100%)';
                    setTimeout(() => {
                        catContainer.style.display = 'none';
                        catContainer.style.visibility = 'hidden';
                        catContainer.style.opacity = '0';
                        catContainer.style.zIndex = '-999';
                        catContainer.style.transform = 'translate(-50%, 200vh)';
                        setTimeout(() => {
                            catContainer.className = 'cat-container';
                            catContainer.style.cssText = '';
                            catImageElement.style.cssText = '';
                            catImageElement.src = '';
                        }, 200);
                    }, 3000);
                }, 900);
            }, 100);
        };

        /**************************************************************************
         * End of unchanged cat animation code.
         **************************************************************************/

        /**************************************************************************
         * CLUBS: fetching, filtering, rendering, selection, persistence, printing
         **************************************************************************/

        let clubsData = []; // will hold parsed clubs (including urn)
        const clubsList = document.getElementById('clubs-list');
        const noResultsMessage = document.getElementById('no-results');

        // UI elements
        const filterBtn = document.getElementById('filter-btn');
        const closeFilterBtn = document.getElementById('close-filter-btn');
        const filterPanel = document.getElementById('filter-panel');
        const filterOverlay = document.getElementById('filter-overlay');
        const searchInput = document.getElementById('search-input');
        const yearFilter = document.getElementById('year-filter');
        const yearFilterPanel = document.getElementById('year-filter-panel');
        const departmentFilter = document.getElementById('department-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const clearYearBtn = document.getElementById('clear-year-btn');
        const clearDayBtn = document.getElementById('clear-day-btn');
        const clearWhenBtn = document.getElementById('clear-when-btn');
        const clearDepartmentBtn = document.getElementById('clear-department-btn');
        const clearClubNameBtn = document.getElementById('clear-club-name-btn');
        const activeFiltersSummary = document.getElementById('active-filters-summary');
        const dayFilterContainer = document.getElementById('day-filter');
        const whenFilterContainer = document.getElementById('when-filter');
        const clubNameFilterContainer = document.getElementById('club-name-filter');

        // Print controls
        const printMyBtn = document.getElementById('print-my-btn'); // full year print (shows when year selected)
        const printPersonalBtn = document.getElementById('print-personal-btn'); // personal selected-clubs print
        const includeOtherInline = document.getElementById('include-other-clubs-inline');
        const printIframe = document.getElementById('print-iframe');

        // Selection persistence (using URN)
        const STORAGE_KEY = 'lms_selected_clubs_v1';
        let selectedClubs = new Set(); // stores URN strings

        function loadSelections() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const arr = JSON.parse(raw);
                if (Array.isArray(arr)) arr.forEach(u => selectedClubs.add(String(u)));
            } catch (e) {
                console.warn('Failed to load selections from localStorage', e);
            }
        }
        function saveSelections() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(selectedClubs)));
            } catch (e) {
                console.warn('Failed to save selections', e);
            }
        }

        // Utility: escape HTML for safe output
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
        }

        // Week flag detection (W1/W2). If weeks field explicitly indicates only 1 or only 2, return '(W1-only)' or '(W2-only)'
        function detectWeekFlag(weeks) {
            if (!weeks) return '';
            const normalized = String(weeks).replace(/\s+/g, '').toLowerCase();
            if (normalized === '1&2' || normalized === '1and2' || normalized === '1-2' || normalized === '12' || normalized === '1/2') return '';
            if (normalized.includes('1') && !normalized.includes('2')) return ' (W1-only)';
            if (normalized.includes('2') && !normalized.includes('1')) return ' (W2-only)';
            if (/week\s*1/i.test(weeks) && !/week\s*2/i.test(weeks)) return ' (W1-only)';
            if (/week\s*2/i.test(weeks) && !/week\s*1/i.test(weeks)) return ' (W2-only)';
            return '';
        }

        // Special notes appended after club names
        function specialClubNote(name) {
            if (!name) return '';
            const n = name.toLowerCase();
            if (n.includes('lunch club')) return ' 12:45 start';
            if (n.includes('chamber choir')) return ' 16:45 finish';
            if (n.includes('orchestra')) return ' 16:45 finish';
            return '';
        }

        // Populate checkboxes helper
        const populateCheckboxes = (container, options, name, defaultSelected = []) => {
            container.innerHTML = '';
            options.forEach(option => {
                const label = document.createElement('label');
                label.className = "flex items-center space-x-2 cursor-pointer";
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '8px';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = name;
                input.value = option;
                if (defaultSelected.includes(option)) input.checked = true;
                const span = document.createElement('span');
                span.textContent = option;
                span.style.color = '#374151';
                label.appendChild(input);
                label.appendChild(span);
                container.appendChild(label);
            });
        };

        // Fetch CSV, parse including URN (10th column), populate filters, initial render
        const fetchAndRenderClubs = async () => {
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.classList.remove('hidden');

            try {
                const response = await fetch('clubs.csv', {cache: 'no-store'});
                const text = await response.text();

                const rows = text.trim().split('\n').slice(1);
                clubsData = rows.map(row => {
                    const cols = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                    return {
                        urn: cols[9] ? String(cols[9]) : (cols[0] + '::' + Math.random().toString(36).slice(2,8)),
                        name: cols[0] || '',
                        when: cols[1] || '',
                        day: cols[2] || '',
                        weeks: cols[3] || '',
                        time: cols[4] || '',
                        yearRaw: cols[5] || '',
                        year: (cols[5] && cols[5].toLowerCase().includes('all years')) ? ['All Years'] : (cols[5] ? cols[5].split(/[,\s&]+/).map(y=>y.trim()).filter(Boolean) : []),
                        location: cols[6] || '',
                        staff: cols[7] || '',
                        department: cols[8] || ''
                    };
                }).filter(c => c.name);

                const uniqueDays = ['All', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const uniqueTimes = ['All', 'Before School', 'Lunchtime', 'After School'];
                const uniqueClubNames = [...new Set(clubsData.map(c => c.name))].filter(Boolean).sort();

                populateCheckboxes(dayFilterContainer, uniqueDays, 'day', ['All']);
                populateCheckboxes(whenFilterContainer, uniqueTimes, 'when', ['All']);
                populateCheckboxes(clubNameFilterContainer, uniqueClubNames, 'club-name');

                loadingMessage.classList.add('hidden');

                // initial render (restore selections first)
                loadSelections();
                renderClubs(clubsData);
                updateUIFromSelections();

            } catch (error) {
                console.error("Error fetching or parsing CSV:", error);
                loadingMessage.innerHTML = `<p class="mt-4 text-xl font-medium text-red-500">Failed to load data. Please check the file.</p>`;
            }
        };

        // Build active filters summary
        const updateFilterSummary = () => {
            const parts = [];
            const year = yearFilter.value;
            if (year) parts.push(`Year: ${year}`);
            const dept = departmentFilter.value;
            if (dept) parts.push(`Dept: ${dept}`);
            const selectedDays = Array.from(document.querySelectorAll('#day-filter input[name="day"]:checked')).map(cb => cb.value);
            if (selectedDays.length>0 && !selectedDays.includes('All')) parts.push(`Day: ${selectedDays.join(', ')}`);
            const selectedWhen = Array.from(document.querySelectorAll('#when-filter input[name="when"]:checked')).map(cb => cb.value);
            if (selectedWhen.length>0 && !selectedWhen.includes('All')) parts.push(`When: ${selectedWhen.join(', ')}`);
            const selectedClubNames = Array.from(document.querySelectorAll('#club-name-filter input[name="club-name"]:checked')).map(cb => cb.value);
            if (selectedClubNames.length>0) parts.push(`Club: ${selectedClubNames.join(', ')}`);
            activeFiltersSummary.textContent = parts.length ? parts.join(' | ') : 'All clubs shown';
        };

        // Filtering logic
        const filterClubs = () => {
            const year = yearFilter.value;
            const dept = departmentFilter.value;
            const searchTerm = (searchInput.value || '').toLowerCase();
            const selectedDays = Array.from(document.querySelectorAll('#day-filter input[name="day"]:checked')).map(cb => cb.value);
            const selectedWhen = Array.from(document.querySelectorAll('#when-filter input[name="when"]:checked')).map(cb => cb.value);
            const selectedClubNames = Array.from(document.querySelectorAll('#club-name-filter input[name="club-name"]:checked')).map(cb => cb.value);

            const filtered = clubsData.filter(club => {
                const hay = (club.name + ' ' + club.department + ' ' + club.location + ' ' + club.staff).toLowerCase();
                if (searchTerm && !hay.includes(searchTerm)) return false;
                if (year && !(club.year.includes('All Years') || club.year.includes(year))) return false;
                if (!(selectedDays.includes('All') || selectedDays.length === 0 || selectedDays.includes(club.day))) return false;
                if (!(selectedWhen.includes('All') || selectedWhen.length === 0 || selectedWhen.includes(club.when))) return false;
                if (dept && club.department !== dept) return false;
                if (selectedClubNames.length && !selectedClubNames.includes(club.name)) return false;
                return true;
            });

            renderClubs(filtered);
            updateFilterSummary();
        };

        // Renders club cards. Adds checkbox bottom-right. Checkbox enabled if year selected or club is previously selected.
        const renderClubs = (clubs) => {
            clubsList.innerHTML = '';
            if (clubs.length === 0) {
                noResultsMessage.classList.remove('hidden');
                return;
            } else {
                noResultsMessage.classList.add('hidden');
            }

            clubs.forEach(club => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-xl shadow-md border border-gray-200 transition-all duration-300 hover:shadow-lg club-card";
                if (selectedClubs.has(club.urn)) card.classList.add('club-selected');

                card.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${escapeHtml(club.name)}</h3>
                    <div class="flex flex-wrap items-center gap-x-4 text-sm text-gray-600 mb-2">
                        <div>Day: <span class="font-semibold">${escapeHtml(club.day)}</span></div>
                        <div>When: <span class="font-semibold">${escapeHtml(club.when)}</span></div>
                        <div>Years: <span class="font-semibold">${escapeHtml(club.year.join(', '))}</span></div>
                        <div>Dept: <span class="font-semibold">${escapeHtml(club.department)}</span></div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2 border-t pt-2 border-gray-100">
                        Where: <span class="font-semibold text-gray-700">${escapeHtml(club.location)}</span>, Who: <span class="font-semibold text-gray-700">${escapeHtml(club.staff)}</span>, Time: <span class="font-semibold text-gray-700">${escapeHtml(club.time)}</span>
                    </p>
                `;

                // Checkbox
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'club-select-box';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'club-select-checkbox';
                cb.value = club.urn;
                cb.checked = selectedClubs.has(club.urn);

                // enable if year selected OR if previously selected (persisted)
                cb.disabled = !( (yearFilter.value && yearFilter.value !== '') || selectedClubs.has(club.urn) );
                cb.title = cb.disabled ? 'Select a year group to enable selection' : 'Select this club';

                cb.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedClubs.add(club.urn);
                    } else {
                        selectedClubs.delete(club.urn);
                    }
                    saveSelections();
                    // Update highlight on the card
                    if (selectedClubs.has(club.urn)) card.classList.add('club-selected'); else card.classList.remove('club-selected');
                    updateFloatingPrintVisibility();
                });

                checkboxWrapper.appendChild(cb);
                card.appendChild(checkboxWrapper);
                clubsList.appendChild(card);
            });
        };

        function updateFloatingPrintVisibility() {
            if (selectedClubs.size > 0) {
                document.getElementById('floating-print-controls')?.classList.remove('hidden');
                printPersonalBtn.style.display = 'inline-block';
            } else {
                document.getElementById('floating-print-controls')?.classList.add('hidden');
                printPersonalBtn.style.display = 'none';
            }
        }

        // file -> grid builder for timetable
        function buildGridForClubs(clubsArray) {
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
            const whens = ['Before School','Lunchtime','After School'];
            const times = {
                'Before School':'08:00-08:30',
                'Lunchtime':'12:45-13:30',
                'After School':'15:30-16:30'
            };
            const grid = {};
            whens.forEach(w => { grid[w] = {}; days.forEach(d => grid[w][d] = []); });
            clubsArray.forEach(club => {
                const when = club.when || 'After School';
                const day = club.day || '';
                if (grid[when] && grid[when][day]) grid[when][day].push(club);
            });
            return { grid, days, whens, times };
        }

        // Create printable HTML for timetable (selected or full year)
        function createPrintableTimetableHTML({ title, clubsArray, includeSmallOther = null }) {
            const { grid, days, whens, times } = buildGridForClubs(clubsArray);

            const printStyles = `
                <style>
                    @page { margin: 18mm; }
                    body { font-family: Inter, Arial, sans-serif; color:#111827; margin:0; padding:14px; }
                    h1 { font-size:18pt; margin:0 0 8px 0; }
                    .meta { font-size:10pt; color:#6b7280; margin-bottom:8px; }
                    table { width:100%; border-collapse: collapse; table-layout: fixed; }
                    th, td { border:1px solid #e6e6e6; padding:8px; vertical-align: top; word-wrap: break-word; }
                    th { background:#f8fafc; font-weight:700; text-align:left; font-size:11pt; }
                    td { font-size:10pt; }
                    .club { margin-bottom:8px; padding:6px; border-radius:6px; background:#fff; }
                    .week-flag { font-weight:700; margin-left:6px; }
                    .small-other { font-size:9.5pt; color:#6b7280; margin-bottom:4px; }
                    .time-note { font-size:10pt; color:#6b7280; margin-top:4px; }
                </style>
            `;

            let html = `<h1>${escapeHtml(title)}</h1>`;
            html += `<div class="meta">Generated: ${new Date().toLocaleString()}</div>`;
            html += `<table><thead><tr><th>When / Day</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>`;

            whens.forEach(w => {
                html += `<tr><th>${w}<div class="time-note">${times[w]}</div></th>`;
                days.forEach(d => {
                    const cellClubs = grid[w][d] || [];
                    if (!cellClubs.length) {
                        html += `<td style="min-height:70px;">—</td>`;
                    } else {
                        let cellHtml = '';
                        cellClubs.forEach(club => {
                            const wf = detectWeekFlag(club.weeks); // returns ' (W1-only)' etc or ''
                            const note = specialClubNote(club.name); // ' 12:45 start' etc
                            cellHtml += `<div class="club"><div><strong>${escapeHtml(club.name)}</strong>${wf ? `<strong class="week-flag">${escapeHtml(wf)}</strong>` : ''}${note ? ` — ${escapeHtml(note.trim())}` : ''}</div>`;
                            cellHtml += `<div>Year: ${escapeHtml(club.year.join(', '))}</div>`;
                            cellHtml += `<div>Where: ${escapeHtml(club.location)}</div>`;
                            cellHtml += `<div>Who: ${escapeHtml(club.staff)}</div>`;
                            cellHtml += `</div>`;
                        });
                        html += `<td>${cellHtml}</td>`;
                    }
                });
                html += `</tr>`;
            });

            html += `</tbody></table>`;

            if (includeSmallOther !== null) {
                html += `<div style="margin-top:14px;"><strong>Other clubs available (small)</strong>`;
                if (!includeSmallOther || includeSmallOther.length === 0) {
                    html += `<div class="small-other">None</div>`;
                } else {
                    includeSmallOther.forEach(c => {
                        const wf = detectWeekFlag(c.weeks);
                        html += `<div class="small-other">• ${escapeHtml(c.name)}${wf ? ` ${escapeHtml(wf)}` : ''}</div>`;
                    });
                }
                html += `</div>`;
            }

            return `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(title)}</title>${printStyles}</head><body>${html}</body></html>`;
        }

        // Print via hidden iframe (no popup)
        function printViaIframe(html) {
            const iframe = document.getElementById('print-iframe');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();
            // give it a moment
            setTimeout(() => {
                iframe.contentWindow.focus();
                try { iframe.contentWindow.print(); } catch (e) { alert('Unable to trigger print — please use your browser print command.'); }
            }, 500);
        }

        // Print all clubs for selected year (full timetable)
        function printYearGroupTimetable() {
            const year = yearFilter.value;
            if (!year) {
                alert('Please select a year group to print the full year timetable.');
                return;
            }
            const clubsForYear = clubsData.filter(c => c.year.includes('All Years') || c.year.includes(year));
            const html = createPrintableTimetableHTML({ title: `All clubs — Year ${year} timetable`, clubsArray: clubsForYear, includeSmallOther: null });
            printViaIframe(html);
        }

        // Print personal selected clubs
        function printPersonalSelectedTimetable() {
            if (selectedClubs.size === 0) {
                alert('Please select at least one club using the checkboxes to print your personal timetable.');
                return;
            }
            const selectedArray = clubsData.filter(c => selectedClubs.has(c.urn));
            let includeSmall = null;
            if (includeOtherInline.checked && yearFilter.value) {
                const year = yearFilter.value;
                includeSmall = clubsData.filter(c => (c.year.includes('All Years') || c.year.includes(year)) && !selectedClubs.has(c.urn));
            }
            const html = createPrintableTimetableHTML({ title: 'My clubs timetable', clubsArray: selectedArray, includeSmallOther: includeSmall });
            printViaIframe(html);
        }

        // Update UI (enable/disable checkboxes) after selection restore or year change
        function updateUIFromSelections() {
            // Re-render so that checkboxes' disabled/enabled reflect current year/selection state
            filterClubs();
            // Show/hide print buttons based on year/selection
            printMyBtn.style.display = yearFilter.value ? 'inline-block' : 'none';
            printPersonalBtn.style.display = selectedClubs.size ? 'inline-block' : 'none';
            updateFloatingPrintVisibility();
            // Update the helper text when year selected
            if (yearFilter.value) {
                document.getElementById('year-helper').textContent = 'Select clubs to enable personal timetable printing';
            } else {
                document.getElementById('year-helper').textContent = 'Select a year to enable club selection & printing';
            }
        }

        /**********************
         * Event listeners
         **********************/
        filterBtn.addEventListener('click', () => {
            filterPanel.classList.add('is-active');
            filterOverlay.classList.remove('hidden');
            filterBtn.setAttribute('aria-expanded','true');
            handleInteraction();
        });
        closeFilterBtn.addEventListener('click', () => {
            filterPanel.classList.remove('is-active');
            filterOverlay.classList.add('hidden');
            filterBtn.setAttribute('aria-expanded','false');
            handleInteraction();
        });
        filterOverlay.addEventListener('click', () => {
            filterPanel.classList.remove('is-active');
            filterOverlay.classList.add('hidden');
            filterBtn.setAttribute('aria-expanded','false');
            handleInteraction();
        });

        clearYearBtn.addEventListener('click', () => {
            yearFilter.value = '';
            yearFilterPanel.value = '';
            updateUIFromSelections();
            handleInteraction();
        });

        clearDayBtn.addEventListener('click', () => {
            document.querySelectorAll('#day-filter input').forEach(cb => { cb.checked = cb.value === 'All'; });
            filterClubs();
            handleInteraction();
        });
        clearWhenBtn.addEventListener('click', () => {
            document.querySelectorAll('#when-filter input').forEach(cb => { cb.checked = cb.value === 'All'; });
            filterClubs();
            handleInteraction();
        });
        clearDepartmentBtn.addEventListener('click', () => {
            departmentFilter.value = '';
            filterClubs();
            handleInteraction();
        });
        clearClubNameBtn.addEventListener('click', () => {
            document.querySelectorAll('#club-name-filter input').forEach(cb => { cb.checked = false; });
            filterClubs();
            handleInteraction();
        });

        searchInput.addEventListener('input', () => { filterClubs(); handleInteraction(); });

        // Year filtering - both selects (main and panel) should keep in sync
        yearFilter.addEventListener('change', () => {
            yearFilterPanel.value = yearFilter.value;
            updateUIFromSelections();
            handleInteraction();
        });
        yearFilterPanel.addEventListener('change', () => {
            yearFilter.value = yearFilterPanel.value;
            updateUIFromSelections();
            handleInteraction();
        });

        departmentFilter.addEventListener('change', () => { filterClubs(); handleInteraction(); });

        // Checkbox groups "All" behaviour restored: selecting All unchecks others; selecting any other unchecks All
        [dayFilterContainer, whenFilterContainer, clubNameFilterContainer].forEach(container => {
            container.addEventListener('change', (event) => {
                if (!event.target) return;
                const el = event.target;
                const inputs = Array.from(container.querySelectorAll('input'));
                if (el.value === 'All' && el.checked) {
                    inputs.forEach(i => { if (i.value !== 'All') i.checked = false; });
                } else if (el.value !== 'All' && el.checked) {
                    const allBox = container.querySelector('input[value="All"]');
                    if (allBox) allBox.checked = false;
                }
                filterClubs();
                handleInteraction();
            });
        });

        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            yearFilter.value = '';
            yearFilterPanel.value = '';
            departmentFilter.value = '';
            document.querySelectorAll('#day-filter input, #when-filter input').forEach(cb => { cb.checked = cb.value === 'All'; });
            document.querySelectorAll('#club-name-filter input').forEach(cb => { cb.checked = false; });
            selectedClubs.clear();
            saveSelections();
            updateUIFromSelections();
            filterClubs();
            handleInteraction();
        });

        // Print buttons
        printMyBtn.addEventListener('click', printYearGroupTimetable);
        printPersonalBtn.addEventListener('click', printPersonalSelectedTimetable);

        // show ascending cat test on load (as original)
        document.addEventListener('DOMContentLoaded', showAscendingCatForTesting);

        // periodic interaction counter to trigger cats as before
        setInterval(handleInteraction, 3000);

        // Initial data load
        fetchAndRenderClubs();

        /**************************************************************************
         * Helper: render function for current filters (used above)
         **************************************************************************/
        function renderClubsFilteredByCurrentFilters() { filterClubs(); }

        // Expose filterClubs in case other code calls it (keeps API stable)
        window.filterClubs = filterClubs;

        /**************************************************************************
         * Printing: button / floating UI initial state update
         **************************************************************************/
        // Ensure floating controls area exists in DOM (we inserted inline top controls and a floating area)
        (function ensureFloatingControls() {
            // Floating controls element (create it if missing)
            if (!document.getElementById('floating-print-controls')) {
                const el = document.createElement('div');
                el.id = 'floating-print-controls';
                el.className = 'hidden';
                el.innerHTML = `<label style="display:flex;align-items:center;gap:8px;"><input id="include-other-clubs-floating" type="checkbox" /> Also print other available clubs (small)</label><button id="floating-print-personal" class="print-personal">Print My Timetable</button>`;
                document.body.appendChild(el);
                // wire up if we created it
                const floatingPersonal = document.getElementById('floating-print-personal');
                if (floatingPersonal) floatingPersonal.addEventListener('click', printPersonalSelectedTimetable);
                const floatingInclude = document.getElementById('include-other-clubs-floating');
                if (floatingInclude) floatingInclude.addEventListener('change', (e) => {
                    // sync with inline checkbox
                    includeOtherInline.checked = e.target.checked;
                });
            } else {
                // sync inline include-other checkbox to floating one if both exist
                const floatingInclude = document.querySelector('#floating-print-controls input[type="checkbox"]');
                if (floatingInclude) {
                    floatingInclude.addEventListener('change', (e) => { includeOtherInline.checked = e.target.checked; });
                    includeOtherInline.addEventListener('change', (e) => { floatingInclude.checked = e.target.checked; });
                }
            }
        })();

    </script>

</body>
</html>
