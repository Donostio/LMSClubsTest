<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Clubs</title>
  <link rel="icon" type="image/png" href="lms_logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
      background-color: #000;
      background-image: repeating-linear-gradient(
        to right,
        #ef4444,
        #ef4444 2px,
        #000 2px,
        #000 24px
      );
    }

    .club-selected {
      box-shadow: 0 0 0 3px rgba(0,0,0,1), 0 0 0 6px rgba(239,68,68,0.95);
      border: 2px solid rgba(239,68,68,0.9);
    }
    .club-select-box {
      position: absolute;
      right: 12px;
      bottom: 12px;
    }

    #floating-print-controls {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 120;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #print-my-btn {
      background: linear-gradient(90deg, #ef4444, #000);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      border: none;
      cursor: pointer;
    }
    #print-year-btn {
      margin-left: 8px;
      background: #111827;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .helper-small { font-size: 12px; color: #6b7280; }

    @media print {
      #filter-panel, #filter-btn, #search-input,
      #floating-print-controls, .filter-overlay {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

  <!-- Page wrapper -->
  <div class="relative w-full max-w-2xl mx-auto flex flex-col p-4 sm:p-6 bg-white rounded-b-3xl shadow-lg">

    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-bold text-gray-800">LMS Clubs 2025-26</h1>
      <button id="filter-btn" class="p-2 bg-purple-600 text-white rounded-full shadow-md hover:bg-purple-700">
        Filters
      </button>
    </div>

    <div id="active-filters-summary" class="text-sm text-gray-500 mb-4"></div>

    <div class="relative mb-6">
      <input type="text" id="search-input" placeholder="Search for a club..."
        class="w-full pl-10 pr-4 py-2 rounded-xl border-2 border-gray-200">
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel"
      class="fixed right-0 top-0 h-full w-full max-w-sm bg-white shadow-xl z-50 p-6 flex flex-col translate-x-full transition-transform">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Filters</h2>
        <button id="close-filter-btn">âœ•</button>
      </div>

      <div>
        <label for="year-filter" class="block font-medium mb-1">Year Group</label>
        <div class="flex items-center gap-2 mb-2">
          <button id="clear-year-btn" class="text-xs text-purple-600">Clear</button>
          <button id="print-year-btn" class="hidden">Print year timetable</button>
        </div>
        <select id="year-filter" class="w-full p-2 rounded border">
          <option value="">All</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
          <option value="11">11</option><option value="12">12</option>
          <option value="13">13</option>
        </select>
        <p id="year-helper" class="helper-small mt-1">
          Select a year to enable club selection and timetable printing.
        </p>
      </div>
    </div>

    <!-- Club cards -->
    <div id="clubs-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

    <div id="no-results" class="hidden text-center text-gray-500 py-12">No clubs found.</div>

    <div class="text-center text-xs text-gray-400 mt-8">
      <p>Site maintained by LMS class reps ðŸš€</p>
    </div>
  </div>

  <!-- Floating Print Controls -->
  <div id="floating-print-controls" class="hidden">
    <label class="flex items-center gap-2 helper-small">
      <input type="checkbox" id="include-other-clubs" />
      <span>Also print other available clubs (small)</span>
    </label>
    <button id="print-my-btn">Print My Timetable</button>
  </div>

  <script>
    let clubsData = [];
    const clubsList = document.getElementById('clubs-list');
    const yearFilter = document.getElementById('year-filter');
    const printYearBtn = document.getElementById('print-year-btn');
    const floatingPrintControls = document.getElementById('floating-print-controls');
    const printMyBtn = document.getElementById('print-my-btn');
    const includeOtherClubsCheckbox = document.getElementById('include-other-clubs');

    // Selected clubs stored as URNs
    let selectedClubs = new Set();

    // Load selections from localStorage
    const loadSelections = () => {
      const saved = localStorage.getItem('selectedClubs');
      if (saved) selectedClubs = new Set(JSON.parse(saved));
    };
    const saveSelections = () => {
      localStorage.setItem('selectedClubs', JSON.stringify(Array.from(selectedClubs)));
    };

    // Parse CSV
    async function fetchAndRenderClubs() {
      const response = await fetch('clubs.csv');
      const text = await response.text();
      const rows = text.trim().split('\n').slice(1);

      clubsData = rows.map(row => {
        const cols = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
        return {
          urn: cols[9],
          name: cols[0],
          when: cols[1],
          day: cols[2],
          weeks: cols[3],
          time: cols[4],
          year: cols[5].includes('All Years') ? ['All Years'] : cols[5].split(/[,& ]+/).filter(Boolean),
          location: cols[6],
          staff: cols[7],
          department: cols[8]
        };
      });

      renderClubs(clubsData);
    }

    // Render club cards
    function renderClubs(clubs) {
      clubsList.innerHTML = '';
      clubs.forEach(club => {
        const card = document.createElement('div');
        card.className = "relative bg-white p-4 rounded shadow";
        if (selectedClubs.has(club.urn)) card.classList.add('club-selected');

        card.innerHTML = `<h3 class="font-bold">${club.name}</h3>
          <p class="text-sm text-gray-600">${club.day}, ${club.when}</p>
          <p class="text-xs text-gray-400">${club.location} â€” ${club.staff}</p>`;

        // Selection checkbox
        const wrapper = document.createElement('div');
        wrapper.className = 'club-select-box';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = club.urn;
        cb.checked = selectedClubs.has(club.urn);
        cb.disabled = !yearFilter.value;
        cb.addEventListener('change', e => {
          if (e.target.checked) selectedClubs.add(club.urn);
          else selectedClubs.delete(club.urn);
          saveSelections();
          renderClubs(clubsData); // re-render to update highlight
          updateFloatingPrintVisibility();
        });
        wrapper.appendChild(cb);
        card.appendChild(wrapper);
        clubsList.appendChild(card);
      });
      updateFloatingPrintVisibility();
    }

    // Floating controls visibility
    function updateFloatingPrintVisibility() {
      if (selectedClubs.size > 0) floatingPrintControls.classList.remove('hidden');
      else floatingPrintControls.classList.add('hidden');
    }

    // Week flags
    const detectWeekFlag = (weeks) => {
      if (!weeks || weeks === '1&2') return '';
      if (weeks.includes('1')) return 'W1-only';
      if (weeks.includes('2')) return 'W2-only';
      return '';
    };

    // Special club notes
    const addSpecialNotes = (name) => {
      if (name.toLowerCase().includes('lunch club')) return ' (12:45 start)';
      if (name.toLowerCase().includes('chamber choir')) return ' (16:45 finish)';
      if (name.toLowerCase().includes('orchestra')) return ' (16:45 finish)';
      return '';
    };

    // Build timetable grid
    function buildGrid(clubs) {
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
      const whens = ['Before School','Lunchtime','After School'];
      const times = {
        'Before School':'08:00-08:30',
        'Lunchtime':'12:45-13:30',
        'After School':'15:30-16:30'
      };
      const grid = {};
      whens.forEach(w => { grid[w] = {}; days.forEach(d => grid[w][d] = []); });
      clubs.forEach(c => { if (grid[c.when] && grid[c.when][c.day]) grid[c.when][c.day].push(c); });
      return {grid, days, whens, times};
    }

    // Printable timetable HTML
    function createPrintableHTML({title, clubsArray, includeSmallOther=null}) {
      const {grid, days, whens, times} = buildGrid(clubsArray);

      const styles = `
        <style>
          @page { margin:20mm; }
          body { font-family:Inter, sans-serif; font-size:12pt; }
          h1 { font-size:18pt; margin-bottom:6pt; }
          table { width:100%; border-collapse: collapse; }
          th,td { border:1px solid #ddd; padding:6pt; vertical-align:top; }
          th { background:#f9fafb; }
          .club { margin-bottom:6pt; }
          .small-other { font-size:10pt; color:#555; }
        </style>`;

      let html = `<h1>${title}</h1><div>Generated: ${new Date().toLocaleString()}</div>`;
      html += `<table><thead><tr><th>When / Day</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;

      whens.forEach(w => {
        html += `<tr><th>${w}<br><small>${times[w]}</small></th>`;
        days.forEach(d => {
          const clubs = grid[w][d];
          if (clubs.length===0) { html += `<td>â€”</td>`; return; }
          let cell='';
          clubs.forEach(c=>{
            const weekFlag = detectWeekFlag(c.weeks);
            const notes = addSpecialNotes(c.name);
            cell += `<div class="club"><b>${c.name}</b>${weekFlag?` <i>${weekFlag}</i>`:''}${notes}<br>
              Year: ${c.year.join(', ')}<br>
              Who: ${c.staff}<br>
              Where: ${c.location}</div>`;
          });
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;

      // Other clubs small
      if (includeSmallOther) {
        html += `<h2>Other clubs available</h2>`;
        includeSmallOther.forEach(c=>{
          const weekFlag = detectWeekFlag(c.weeks);
          html += `<div class="small-other">â€¢ ${c.name}${weekFlag?` (${weekFlag})`:''}</div>`;
        });
      }

      return `<!doctype html><html><head>${styles}</head><body>${html}</body></html>`;
    }

    function openPrint(html) {
      const w=window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      setTimeout(()=>w.print(),500);
    }

    // Print functions
    function printYearGroupTimetable() {
      const year = yearFilter.value;
      if (!year) { alert('Select a year'); return; }
      const clubsForYear = clubsData.filter(c=>c.year.includes('All Years')||c.year.includes(year));
      const html=createPrintableHTML({title:`All Clubs â€” Year ${year}`, clubsArray:clubsForYear});
      openPrint(html);
    }
    function printCustomTimetable() {
      if (selectedClubs.size===0) { alert('Select clubs'); return; }
      const selectedArray = clubsData.filter(c=>selectedClubs.has(c.urn));
      let includeSmall=null;
      if (includeOtherClubsCheckbox.checked && yearFilter.value) {
        const year=yearFilter.value;
        includeSmall = clubsData.filter(c=>(c.year.includes('All Years')||c.year.includes(year)) && !selectedClubs.has(c.urn));
      }
      const html=createPrintableHTML({title:'My Clubs Timetable', clubsArray:selectedArray, includeSmallOther:includeSmall});
      openPrint(html);
    }

    // Event listeners
    printYearBtn.addEventListener('click', printYearGroupTimetable);
    printMyBtn.addEventListener('click', printCustomTimetable);
    yearFilter.addEventListener('change', ()=>renderClubs(clubsData));

    // Init
    loadSelections();
    fetchAndRenderClubs();
  </script>
</body>
</html>

