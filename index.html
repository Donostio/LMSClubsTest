<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LMS Clubs â€” Complete</title>
  <link rel="icon" type="image/png" href="lms_logo.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{--muted:#6b7280;--red:#ef4444;--black:#000;}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;}
    body{
      background:#000;
      background-image:repeating-linear-gradient(to right,var(--red),var(--red) 2px,#000 2px,#000 24px);
      -webkit-font-smoothing:antialiased;
    }
    .page{max-width:1180px;margin:24px auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 18px 60px rgba(0,0,0,0.18);}
    header.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    header.top h1{margin:0;font-size:20px;font-weight:700;color:#111;}
    /* controls */
    #year-filter{padding:10px;border-radius:10px;border:1px solid #e6e6e6;width:18%;min-width:84px;color:var(--red);font-weight:600;}
    #print-btn{width:220px;display:inline-block;text-align:center;padding:8px 12px;border-radius:10px;border:none;font-weight:700;color:#fff;background:linear-gradient(90deg,#ef4444,#000);cursor:pointer;}
    #search-input{padding:10px;border-radius:10px;border:1px solid #e6e6e6;width:320px;}
    #active-filters-summary{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px;}
    #clubs-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px;}
    .club-card{position:relative;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;color:#111;min-height:120px;transition:box-shadow .15s,transform .12s;}
    .club-card:hover{transform:translateY(-4px);box-shadow:0 8px 28px rgba(0,0,0,0.06);}
    .muted{color:var(--muted);}
    .club-select-box{position:absolute;right:12px;bottom:12px;}
    .club-select-box input{display:none;}
    .club-select-box.show input{display:block;}
    .selected{box-shadow:0 0 0 3px rgba(0,0,0,1),0 0 0 6px rgba(239,68,68,0.95);border:2px solid rgba(239,68,68,0.9);}
    #deselect-all{display:none;background:#fff;border:2px solid rgba(239,68,68,0.9);box-shadow:0 0 0 3px rgba(0,0,0,1),0 0 0 6px rgba(239,68,68,0.95);padding:10px;border-radius:10px;cursor:pointer;font-weight:700;position:relative;}
    #deselect-all svg{position:absolute;right:8px;top:8px;width:18px;height:18px;fill:#fff;background:#111;border-radius:3px;padding:2px;}
    /* toast near card */
    .toast{position:absolute;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(-6px);transition:opacity .18s,transform .18s;pointer-events:none;z-index:300;font-size:13px;}
    .toast.show{opacity:1;transform:translateY(0);}
    /* filter panel transition (kept for compatibility with markup) */
    .filter-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
    .filter-panel.is-active { transform: translateX(0); }
    .backdrop { transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none; }
    .backdrop.is-active { opacity: 1; pointer-events: auto; }
    /* cat */
    #cat-container{position:fixed;z-index:120;pointer-events:none;left:50%;bottom:0;transform:translateX(-50%) translateY(120%);transition:transform .9s cubic-bezier(.2,.9,.3,1),opacity .6s;opacity:0;}
    #cat-container.show{transform:translateX(-50%) translateY(0);opacity:1;}
    #cat-image{width:640px;border-radius:.75rem;display:block;transition:transform .3s;}
    @media print{ @page{size:landscape;margin:10mm;} body{background:#fff;} #filter-panel,#filter-btn,#search-input,.filter-overlay{display:none!important;} }
  </style>
</head>
<body>
  <div id="cat-container"><img id="cat-image" src="" alt="cat"></div>

  <div class="page" role="main">
    <header class="top">
      <h1>Lady Margaret School â€” Clubs 2025-26</h1>
      <button id="filter-btn" aria-controls="filter-panel" aria-expanded="false" style="background:#7c3aed;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;">Filters</button>
    </header>

    <section style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
      <div style="min-width:260px;">
        <label for="year-filter" style="display:block;font-weight:600;margin-bottom:6px;">Year Group</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <select id="year-filter" aria-label="Year group">
            <option value="">All</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
          </select>

          <div id="print-controls" style="display:flex;align-items:center;gap:10px;">
            <button id="print-btn">Print My<br>Timetable</button>
            <span id="year-message" style="color:var(--muted);margin-top:6px;">Filter by year</span>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
          <div style="display:flex;flex-direction:column;flex:1;min-width:0;">
            <label for="search-input" style="display:block;font-weight:600;margin-bottom:6px;">Search</label>
            <input id="search-input" placeholder="Search for a club..." />
          </div>
          <div id="active-filters-summary" style="color:var(--muted);font-size:13px;margin-top:22px;min-width:0;max-width:40%;">All clubs shown</div>
        </div>

        <div style="margin-top:10px;">
          <button id="deselect-all" title="Deselect all selected clubs">Deselect All Clubs
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 12.2l-2.2-2.2L5 11.8 9 15.8 19 5.8 17.6 4.4z"/></svg>
          </button>
        </div>
      </div>

      <div style="flex:1;align-self:flex-end;"></div>
    </section>

    <main>
      <div id="loading-message" style="display:none;color:var(--muted);text-align:center;padding:12px;">Loadingâ€¦</div>
      <div id="clubs-list" aria-live="polite"></div>
      <div id="no-results" style="display:none;color:var(--muted);padding:18px;text-align:center;">No clubs found matching your criteria.</div>
    </main>

    <footer style="margin-top:28px;color:var(--muted);font-size:13px;text-align:center;">
      <div>This site is maintained by LMS class reps ðŸš€</div>
      <div style="margin-top:6px;">Feedback: <a href="https://forms.gle/5Gdrj6RPAEXf7jKy8" target="_blank" rel="noopener" style="color:var(--red)">Please share your thoughts</a></div>
    </footer>
  </div>

  <!-- Filter panel as provided -->
  <div id="filter-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 backdrop-blur-sm backdrop hidden"></div>

  <div id="filter-panel" class="fixed right-0 top-0 h-full w-full max-w-sm bg-white shadow-xl z-50 p-6 flex flex-col filter-panel" aria-hidden="true" role="region" aria-label="Filters">
      <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Filters</h2>
          <button id="close-filter-btn" class="p-2 text-gray-500 rounded-full hover:bg-gray-100 transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
          </button>
      </div>

      <div class="space-y-6 mb-8 overflow-y-auto">
          <div>
              <div class="flex items-center justify-between">
                  <label for="year-filter" class="block text-gray-700 font-medium mb-1">Year Group</label>
                  <button id="clear-year-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
              </div>
              <select id="year-filter-panel" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                  <option value="">All</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
              </select>
          </div>

          <div>
              <div class="flex items-center justify-between">
                  <label class="block text-gray-700 font-medium mb-2">Day</label>
                  <button id="clear-day-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
              </div>
              <div id="day-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200">
              </div>
          </div>

          <div>
              <div class="flex items-center justify-between">
                  <label class="block text-gray-700 font-medium mb-2">When</label>
                  <button id="clear-when-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
              </div>
              <div id="when-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200">
              </div>
          </div>

          <div>
              <div class="flex items-center justify-between">
                  <label for="department-filter" class="block text-gray-700 font-medium mb-1">Department</label>
                  <button id="clear-department-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
              </div>
              <select id="department-filter" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                  <option value="">All</option>
                  <option value="ART">ART</option>
                  <option value="CS">CS</option>
                  <option value="Drama">Drama</option>
                  <option value="DT">DT</option>
                  <option value="English">English</option>
                  <option value="Maths">Maths</option>
                  <option value="Music">Music</option>
                  <option value="Other">Other</option>
                  <option value="Pastoral">Pastoral</option>
                  <option value="PE">PE</option>
                  <option value="RS">RS</option>
                  <option value="Science">Science</option>
                  <option value="SEN">SEN</option>
              </select>
          </div>

          <div>
              <div class="flex items-center justify-between">
                  <label class="block text-gray-700 font-medium mb-2">Club Name</label>
                  <button id="clear-club-name-btn" class="text-xs text-purple-600 hover:text-purple-800 font-semibold transition-colors">Clear</button>
              </div>
              <div id="club-name-filter" class="bg-gray-50 rounded-xl p-4 space-y-2 border border-gray-200 max-h-64 overflow-y-auto">
              </div>
          </div>
      </div>

      <button id="clear-filters-btn" class="w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-colors duration-200 mt-auto">Clear All Filters</button>
  </div>

  <div id="toast" class="toast" aria-live="polite">You have another club then...</div>

  <iframe id="print-iframe" style="display:none;"></iframe>

<script>
/* ========= State & Utilities ========= */
const STORAGE_KEY = 'lms_selected_clubs_final_v5';
let clubsData = [];
let selectedClubs = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

const clubsListEl = document.getElementById('clubs-list');
const loadingMessageEl = document.getElementById('loading-message');
const noResultsEl = document.getElementById('no-results');
const searchInput = document.getElementById('search-input');
const yearFilter = document.getElementById('year-filter');
const yearFilterPanel = document.getElementById('year-filter-panel');
const departmentFilter = document.getElementById('department-filter');
const filterBtn = document.getElementById('filter-btn');
const filterPanel = document.getElementById('filter-panel');
const filterOverlay = document.getElementById('filter-overlay');
const closeFilterBtn = document.getElementById('close-filter-btn');
const clearFiltersBtn = document.getElementById('clear-filters-btn');
const clearYearBtn = document.getElementById('clear-year-btn');
const clearDayBtn = document.getElementById('clear-day-btn');
const clearWhenBtn = document.getElementById('clear-when-btn');
const clearDepartmentBtn = document.getElementById('clear-department-btn');
const clearClubNameBtn = document.getElementById('clear-club-name-btn');
const dayFilterContainer = document.getElementById('day-filter');
const whenFilterContainer = document.getElementById('when-filter');
const clubNameFilterContainer = document.getElementById('club-name-filter');
const activeFiltersSummary = document.getElementById('active-filters-summary');
const printBtn = document.getElementById('print-btn');
const toastEl = document.getElementById('toast');
const deselectBtn = document.getElementById('deselect-all');

/* Utility */
function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function saveSelections(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify([...selectedClubs])); }catch(e){ console.warn('save failed', e); }}

/* Cat animations (same rules) */
const catContainer = document.getElementById('cat-container');
const catImage = document.getElementById('cat-image');
const catImages = ['images/1C.png','images/2C.png','images/3.png'];
function showAscendingCatForTesting(){ if(catImages.length){ catImage.src=catImages[0]; catImage.style.transform='scale(4)'; catContainer.classList.add('show'); setTimeout(()=>{ catImage.style.transform='scale(1)'; catContainer.classList.remove('show'); },2200);} }
function triggerRandomCat(){ if(!catImages.length) return; const idx=Math.floor(Math.random()*catImages.length); catImage.src=catImages[idx]; catContainer.classList.add('show'); setTimeout(()=>catContainer.classList.remove('show'),2200); }
let interactions=0; let nextShow=20+Math.floor(Math.random()*60);
document.addEventListener('click', ()=>{ interactions++; if(interactions>=nextShow){ triggerRandomCat(); interactions=0; nextShow=20+Math.floor(Math.random()*60);} });
document.addEventListener('mousemove', ()=>{ interactions++; if(interactions>=nextShow){ triggerRandomCat(); interactions=0; nextShow=20+Math.floor(Math.random()*60);} });

/* ========= CSV fetch & parsing ========= */
async function fetchClubsCSV(){
  try{
    loadingMessageEl.style.display='block';
    const res = await fetch('clubs.csv',{cache:'no-store'});
    const txt = await res.text();
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    if(lines.length<=1){ clubsData=[]; renderClubs(); populateCheckboxes(); initFilterLogic(); updateUI(); loadingMessageEl.style.display='none'; return; }
    const rows = lines.slice(1);
    clubsData = rows.map(r=>{
      const cols = r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.trim().replace(/^"|"$/g,''));
      const yearRaw = cols[5]||'';
      let yearArr=[];
      if(yearRaw && yearRaw.toLowerCase().includes('all years')) yearArr=['All Years'];
      else if(yearRaw) yearArr = yearRaw.split(/[,&\/\s]+/).map(x=>x.trim()).filter(Boolean);
      return {
        urn: cols[9] ? String(cols[9]) : (cols[0] + '::' + Math.random().toString(36).slice(2,8)),
        name: cols[0]||'',
        when: cols[1]||'',
        day: cols[2]||'',
        weeks: cols[3]||'',
        time: cols[4]||'',
        yearRaw: yearRaw,
        year: yearArr.length ? yearArr : (yearRaw? [yearRaw]: []),
        location: cols[6]||'',
        staff: cols[7]||'',
        department: cols[8]||''
      };
    });
    populateCheckboxes();
    initFilterLogic();
    renderClubs();
    updateUI();
    loadingMessageEl.style.display='none';
  }catch(err){
    console.error('Failed to load clubs.csv',err);
    loadingMessageEl.innerHTML = '<p style="color:#b91c1c">Failed to load data â€” check clubs.csv</p>';
  }
}

/* ========= Filter helpers & logic ========= */
const populateCheckboxes = (container, options = [], name = 'generic', defaultSelected = []) => {
  if(container === undefined || container === null){
    const uniqueDays = ['All','Monday','Tuesday','Wednesday','Thursday','Friday'];
    const uniqueTimes = ['All','Before School','Lunchtime','After School'];
    const uniqueClubNames = [...new Set(clubsData.map(c=>c.name))].filter(Boolean).sort();
    populateCheckboxes(dayFilterContainer, uniqueDays, 'day', ['All']);
    populateCheckboxes(whenFilterContainer, uniqueTimes, 'when', ['All']);
    populateCheckboxes(clubNameFilterContainer, uniqueClubNames, 'club-name', []);
    return;
  }
  container.innerHTML = '';
  options.forEach(opt=>{
    const label = document.createElement('label');
    label.className = "flex items-center space-x-2 cursor-pointer";
    const isChecked = defaultSelected.includes(opt);
    label.innerHTML = `<input type="checkbox" name="${name}" value="${esc(opt)}" ${isChecked? 'checked':''}> <span style="margin-left:6px;">${esc(opt)}</span>`;
    container.appendChild(label);
  });
};

function getActiveFilters(){
  const year = yearFilter.value || yearFilterPanel.value;
  const department = departmentFilter.value || '';
  const search = (searchInput.value||'').trim().toLowerCase();
  const selectedDays = Array.from(document.querySelectorAll('#day-filter input[name="day"]:checked')).map(i=>i.value);
  const selectedWhens = Array.from(document.querySelectorAll('#when-filter input[name="when"]:checked')).map(i=>i.value);
  const selectedClubNames = Array.from(document.querySelectorAll('#club-name-filter input[name="club-name"]:checked')).map(i=>i.value);
  return {year,department,search,selectedDays,selectedWhens,selectedClubNames};
}

function clubMatchesFilter(club,f){
  if(f.search){
    const hay = (club.name+' '+(club.department||'')+' '+(club.location||'')+' '+(club.staff||'')+' '+(club.year?club.year.join(' '):'')).toLowerCase();
    if(!hay.includes(f.search)) return false;
  }
  if(f.year){
    if(!club.year.includes('All Years') && !club.year.includes(f.year)) return false;
  }
  if(f.selectedClubNames.length){
    if(!f.selectedClubNames.includes(club.name)) return false;
  }
  if(f.selectedDays.length && !f.selectedDays.includes('All')){
    if(!f.selectedDays.includes(club.day)) return false;
  }
  if(f.selectedWhens.length && !f.selectedWhens.includes('All')){
    if(!f.selectedWhens.includes(club.when)) return false;
  }
  if(f.department){
    if(f.department !== '' && club.department !== f.department) return false;
  }
  return true;
}

/* ========= Render clubs ========= */
def_marker = false
def_marker  # harmless placeholder variable in Python context, will be removed in final output

function specialNote(name){
  if(!name) return '';
  const n = name.toLowerCase();
  if(n.includes('lunch club')) return ' <strong>12:45 start</strong>';
  if(n.includes('chamber choir')||n.includes('orchestra')) return ' <strong>16:45 finish</strong>';
  return '';
}

function renderClubs(filtered = null){
  const f = getActiveFilters();
  const list = (filtered || clubsData).filter(c=>clubMatchesFilter(c,f));
  clubsListEl.innerHTML = '';
  if(list.length === 0){ noResultsEl.style.display='block'; } else { noResultsEl.style.display='none'; }
  list.forEach(club=>{
    const card = document.createElement('div');
    card.className = 'club-card';
    card.dataset.urn = club.urn;
    if(selectedClubs.has(club.urn)) card.classList.add('selected');
    let yearsText = club.year.includes('All Years') ? 'All Years' : club.year.join(', ');
    if(f.year && !club.year.includes('All Years')) yearsText = `<span class="muted">Years:</span> ${esc(yearsText)}`;
    else yearsText = esc(yearsText);
    const note = specialNote(club.name);
    card.innerHTML = `<div style="font-weight:700;font-size:15px;margin-bottom:6px;color:#111;">${esc(club.name)}</div>
      <div style="font-size:13px;color:#111;margin-bottom:6px;">${esc(club.day)} â€¢ ${esc(club.when)}</div>
      <div style="font-size:12px;color:#111;margin-bottom:6px;">${yearsText}</div>
      <div style="font-size:12px;color:var(--muted);">Where: <span class="muted">${esc(club.location)}</span> â€¢ Who: <span class="muted">${esc(club.staff)}</span>${note}</div>`;
    // checkbox
    const cbWrap = document.createElement('div'); cbWrap.className='club-select-box';
    if((yearFilter.value || yearFilterPanel.value)) cbWrap.classList.add('show');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.value=club.urn; cb.checked = selectedClubs.has(club.urn);
    cb.disabled = !((yearFilter.value || yearFilterPanel.value) || selectedClubs.has(cb.value));
    cb.addEventListener('change',(e)=>{
      if(e.target.checked){
        const dup = [...selectedClubs].map(id=>clubsData.find(x=>x.urn===id)).find(s=>s && s.day===club.day && s.when===club.when);
        if(dup){
          showToastAbove(card, 'You have another club then...');
        }
        selectedClubs.add(club.urn);
        card.classList.add('selected');
      } else {
        selectedClubs.delete(club.urn);
        card.classList.remove('selected');
      }
      saveSelections();
      updateUI();
    });
    cbWrap.appendChild(cb); card.appendChild(cbWrap);
    clubsListEl.appendChild(card);
  });
}

/* Toast above card */
let toastTimeout = null;
function showToastAbove(card, message){
  toastEl.textContent = message;
  // show immediately so we can measure
  toastEl.classList.add('show');
  // calculate position
  const rect = card.getBoundingClientRect();
  // ensure toast has a measured size
  const tRect = toastEl.getBoundingClientRect();
  const left = window.scrollX + rect.left + (rect.width/2) - (tRect.width/2);
  const top = window.scrollY + rect.top - tRect.height - 8;
  toastEl.style.left = Math.max(8, left) + 'px';
  toastEl.style.top = Math.max(8, top) + 'px';
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{ toastEl.classList.remove('show'); toastTimeout = null; }, 3000);
}

/* ========= Print builder ========= */
function buildGridForPrint(clubs){
  const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
  const whens = ['Before School','Lunchtime','After School'];
  const times = {'Before School':'08:00-08:30','Lunchtime':'12:45-13:30','After School':'15:30-16:30'};
  const grid = {}; whens.forEach(w=>{ grid[w]= {}; days.forEach(d=>grid[w][d]=[]); });
  clubs.forEach(c=>{ if(grid[c.when] && grid[c.when][c.day]) grid[c.when][c.day].push(c); });
  return {grid,days,whens,times};
}
function createPrintHTML(title, selectedArr, othersArr){
  const combined = (selectedArr||[]).concat(othersArr||[]);
  const {grid,days,whens,times} = buildGridForPrint(combined);
  const styles = `<style>@page{size:landscape;margin:12mm;}body{font-family:Inter,Arial,sans-serif;color:#000;margin:0;padding:12px;}h1{font-size:18pt;margin:0 0 8px 0;}table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:10pt;}th,td{border:1px solid #ddd;padding:6px;vertical-align:top;word-break:break-word;}th{background:#f8fafc;text-align:left;font-weight:700;} .club-name{font-weight:700;display:block;margin-bottom:6px;} .selected-box{border:2px solid #000;padding:6px;margin-bottom:6px;} .other-club{font-style:italic;color:#6b7280;font-size:90%;line-height:0.95;margin-bottom:4px;display:block;}</style>`;
  let html = `<div id="printable-area"><h1>${esc(title)}</h1>`;
  html += `<table><thead><tr><th style="width:16%;">When / Day</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
  whens.forEach(w=>{
    html += `<tr><th>${w}<div style="font-size:10pt;color:#6b7280;margin-top:6px;">${times[w]}</div></th>`;
    days.forEach(d=>{
      const cell = grid[w][d] || [];
      if(!cell.length){ html += `<td style="min-height:70px;">â€”</td>`; return; }
      let cellHtml = '';
      // selected first
      cell.forEach(c=>{
        if(selectedArr && selectedArr.find(s=>s.urn===c.urn)){
          const ytext = c.year.includes('All Years') ? 'All Years' : ('Years: '+esc(c.year.join(', ')));
          cellHtml += `<div class="selected-box"><div class="club-name">${esc(c.name)}</div><div style="font-size:10pt;color:#000;">${ytext}</div><div style="font-size:10pt;color:#000;margin-top:6px;">Where: ${esc(c.location)}, Who: ${esc(c.staff)}</div></div>`;
        }
      });
      // others
      cell.forEach(c=>{
        if(othersArr && othersArr.find(o=>o.urn===c.urn)){
          const ytext = c.year.includes('All Years') ? 'All Years' : ('Years: '+esc(c.year.join(', ')));
          cellHtml += `<div class="other-club">${esc(c.name)} (${esc(ytext)})</div>`;
        }
      });
      html += `<td>${cellHtml}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table></div>`;
  return `<!doctype html><html><head><meta charset="utf-8"><title>${esc(title)}</title>${styles}</head><body>${html}</body></html>`;
}
function printViaIframe(html){
  const iframe = document.getElementById('print-iframe');
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
  setTimeout(()=>{ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Unable to trigger print â€” use browser print.'); } }, 400);
}

/* ========= Filter panel wiring & actions ========= */
filterBtn.addEventListener('click', ()=>{
  filterPanel.classList.add('is-active');
  filterOverlay.classList.remove('hidden');
  filterOverlay.classList.add('is-active');
  filterPanel.setAttribute('aria-hidden','false');
  filterBtn.setAttribute('aria-expanded','true');
});
closeFilterBtn.addEventListener('click', ()=>{ filterPanel.classList.remove('is-active'); filterOverlay.classList.add('hidden'); filterOverlay.classList.remove('is-active'); filterPanel.setAttribute('aria-hidden','true'); filterBtn.setAttribute('aria-expanded','false'); });
filterOverlay.addEventListener('click', ()=>{ filterPanel.classList.remove('is-active'); filterOverlay.classList.add('hidden'); filterOverlay.classList.remove('is-active'); filterPanel.setAttribute('aria-hidden','true'); filterBtn.setAttribute('aria-expanded','false'); });

clearYearBtn.addEventListener('click', ()=>{ yearFilter.value=''; yearFilterPanel.value=''; applyFilters(); });
clearDayBtn.addEventListener('click', ()=>{ document.querySelectorAll('#day-filter input').forEach(cb=>cb.checked = (cb.value==='All')); applyFilters(); });
clearWhenBtn.addEventListener('click', ()=>{ document.querySelectorAll('#when-filter input').forEach(cb=>cb.checked = (cb.value==='All')); applyFilters(); });
clearDepartmentBtn.addEventListener('click', ()=>{ departmentFilter.value=''; applyFilters(); });
clearClubNameBtn.addEventListener('click', ()=>{ document.querySelectorAll('#club-name-filter input').forEach(cb=>cb.checked=false); applyFilters(); });

clearFiltersBtn.addEventListener('click', ()=>{ yearFilter.value=''; yearFilterPanel.value=''; departmentFilter.value=''; searchInput.value=''; document.querySelectorAll('#day-filter input').forEach(cb=>cb.checked = (cb.value==='All')); document.querySelectorAll('#when-filter input').forEach(cb=>cb.checked = (cb.value==='All')); document.querySelectorAll('#club-name-filter input').forEach(cb=>cb.checked=false); applyFilters(); });

searchInput.addEventListener('input', ()=>{ applyFilters(); });
yearFilter.addEventListener('change', ()=>{ yearFilterPanel.value = yearFilter.value; applyFilters(); });
yearFilterPanel.addEventListener('change', ()=>{ yearFilter.value = yearFilterPanel.value; applyFilters(); });
departmentFilter.addEventListener('change', ()=>{ applyFilters(); });

/* delegate change for checkbox containers to manage 'All' logic */
[dayFilterContainer, whenFilterContainer, clubNameFilterContainer].forEach(container=>{
  container.addEventListener('change', (ev)=>{
    const target = ev.target;
    if(!target || target.tagName !== 'INPUT') return;
    const val = target.value;
    const inputs = Array.from(container.querySelectorAll('input'));
    if(val === 'All' && target.checked){
      inputs.forEach(i=>{ if(i.value !== 'All') i.checked = false; });
    } else if(val !== 'All' && target.checked){
      const all = container.querySelector('input[value="All"]');
      if(all) all.checked = false;
    }
    applyFilters();
  });
});

/* ========= Apply filters and update UI ========= */
function applyFilters(){
  const filtered = filterClubs();
  renderClubs(filtered);
  updateFilterSummary();
  updateUI();
}

function updateFilterSummary(){
  const parts = [];
  const f = getActiveFilters();
  if(f.year) parts.push(`Year: ${f.year}`);
  if(f.department) parts.push(`Department: ${f.department}`);
  if(f.selectedDays.length && !f.selectedDays.includes('All')) parts.push(`Day: ${f.selectedDays.join(', ')}`);
  if(f.selectedWhens.length && !f.selectedWhens.includes('All')) parts.push(`When: ${f.selectedWhens.join(', ')}`);
  if(f.selectedClubNames.length) parts.push(`Club: ${f.selectedClubNames.join(', ')}`);
  activeFiltersSummary.textContent = parts.length ? parts.join(' | ') : 'All clubs shown';
}

/* filtering function */
function filterClubs(){
  const f = getActiveFilters();
  const filtered = clubsData.filter(c=>clubMatchesFilter(c,f));
  return filtered;
}

/* ========= UI helpers ========= */
function updateUI(){
  // year select color
  if(!yearFilter.value && !yearFilterPanel.value) yearFilter.style.color = 'var(--red)'; else yearFilter.style.color = '#111';
  // manage checkboxes visibility/disabled
  document.querySelectorAll('#clubs-list input[type=checkbox]').forEach(cb=>{
    cb.disabled = !((yearFilter.value || yearFilterPanel.value) || selectedClubs.has(cb.value));
    if(cb.parentElement){ if(yearFilter.value || yearFilterPanel.value) cb.parentElement.classList.add('show'); else cb.parentElement.classList.remove('show'); }
  });
  // helper/deselect logic
  const helper = document.getElementById('helper-text');
  if(selectedClubs.size === 0){ if(helper) helper.style.display = 'inline'; deselectBtn.style.display = 'none'; } else { if(helper) helper.style.display='none'; deselectBtn.style.display = 'inline-block'; }
}

/* ========= Print button action ========= */
printBtn.addEventListener('click', ()=>{
  const y = yearFilter.value || yearFilterPanel.value;
  const clubsForYear = clubsData.filter(c=>c.year.includes('All Years')||c.year.includes(y));
  const selected = clubsForYear.filter(c=>selectedClubs.has(c.urn));
  const others = clubsForYear.filter(c=>!selectedClubs.has(c.urn));
  const title = y ? `Year ${y} Clubs Timetable` : 'Clubs Timetable';
  const html = createPrintHTML(title, selected, others);
  printViaIframe(html);
});

/* ========= Deselect All ========= */
deselectBtn.addEventListener('click', ()=>{
  selectedClubs.clear(); saveSelections();
  document.querySelectorAll('#clubs-list .club-card.selected').forEach(el=>el.classList.remove('selected'));
  document.querySelectorAll('#clubs-list input[type=checkbox]').forEach(cb=>cb.checked=false);
  deselectBtn.style.display='none'; applyFilters();
});

/* ========= Init ========= */
function initFilterLogic(){
  // placeholder kept for compatibility
}
fetchClubsCSV();

/* accessibility */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(filterPanel.classList.contains('is-active')){ filterPanel.classList.remove('is-active'); filterOverlay.classList.add('hidden'); filterOverlay.classList.remove('is-active'); filterPanel.setAttribute('aria-hidden','true'); filterBtn.setAttribute('aria-expanded','false'); } } });

</script>
</body>
</html>
