<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMS Clubs</title>
  <link rel="icon" type="image/png" href="lms_logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    body { font-family: 'Inter', sans-serif; background:#f9fafb; }
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LNV90DS36X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LNV90DS36X');
</script>

    /* Club selection */
    .club-selected { box-shadow: 0 0 0 3px rgba(0,0,0,1), 0 0 0 6px rgba(239,68,68,0.95); border:2px solid rgba(239,68,68,0.9); }
    .club-select-box { position:absolute; right:12px; bottom:12px; }

    /* Year select "All" red */
    #year-filter option[value=""] { color:#ef4444; font-weight:700; }

    /* Grid layout (landscape friendly) */
    #clubs-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; }
    .club-card { background:#fff; border:1px solid #e6e6e6; padding:14px; border-radius:12px; position:relative; transition: box-shadow .15s ease, transform .12s ease; }
    .club-card:hover { box-shadow:0 8px 28px rgba(0,0,0,0.06); transform:translateY(-3px); }

    /* Print adjustments */
    @media print {
      @page { size: landscape; margin:10mm; }
      body { background:#fff; }
      #filter-panel, #filter-btn, #search-input, #floating-print-controls, .filter-overlay { display:none !important; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
  <div class="relative w-full max-w-6xl mx-auto flex flex-col p-4 sm:p-6 bg-white rounded-b-3xl shadow-lg">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-bold text-gray-800">LMS TEST Clubs 2025-26</h1>
      <button id="filter-btn" class="p-2 bg-purple-600 text-white rounded-full shadow-md hover:bg-purple-700 transition-colors" aria-controls="filter-panel">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M6 12h12M10 18h4"/></svg>
      </button>
    </div>

    <div class="relative mb-6 flex flex-col sm:flex-row items-start gap-4">
      <div>
        <label for="year-filter" class="block text-gray-700 font-medium mb-1">Year Group</label>
        <select id="year-filter" class="p-2 rounded-xl border-2 border-gray-200">
          <option value="">All</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
        </select>
        <p class="mt-1 text-gray-500 text-sm">Select a year to enable club selection & printing</p>

        <div class="mt-2 flex flex-col gap-2">
          <button id="print-my-btn" class="hidden bg-gradient-to-r from-red-500 to-black text-white px-4 py-2 rounded-lg font-bold">Print Year-group Timetable</button>
          <button id="print-personal-btn" class="hidden bg-gray-900 text-white px-4 py-2 rounded-lg font-bold">Print my selected-clubs</button>
        </div>
      </div>

      <div class="flex-1">
        <label class="block text-gray-700 font-medium mb-1">Search</label>
        <input id="search-input" type="text" placeholder="Search for a club..." class="w-full pl-3 pr-4 py-2 rounded-xl text-gray-700 border-2 border-gray-200">
      </div>
    </div>

    <div id="clubs-list"></div>
    <div id="no-results" class="hidden text-center text-gray-500 py-8">No clubs found matching your criteria.</div>
  </div>

  <!-- Hidden iframe for print -->
  <iframe id="print-iframe" style="display:none;"></iframe>

  <script>
    let clubsData=[]; let selectedClubs=new Set();
    const clubsList=document.getElementById('clubs-list');
    const yearFilter=document.getElementById('year-filter');
    const searchInput=document.getElementById('search-input');
    const printMyBtn=document.getElementById('print-my-btn');
    const printPersonalBtn=document.getElementById('print-personal-btn');

    function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

    function renderClubs(data){
      clubsList.innerHTML='';
      const filtered=data.filter(c=>{
        const term=(searchInput.value||'').toLowerCase();
        return !term || (c.name+c.department+c.location+c.staff).toLowerCase().includes(term);
      });
      if(filtered.length===0){document.getElementById('no-results').classList.remove('hidden');return;}
      document.getElementById('no-results').classList.add('hidden');
      filtered.forEach(club=>{
        const card=document.createElement('div');
        card.className='club-card';
        if(selectedClubs.has(club.urn)) card.classList.add('club-selected');
        card.innerHTML=`
          <div style="font-weight:700;font-size:15px;margin-bottom:6px;">${escapeHtml(club.name)}</div>
          <div style="font-size:13px;color:#475569;margin-bottom:6px;">${escapeHtml(club.day)} • ${escapeHtml(club.when)}</div>
          <div style="font-size:12px;color:#6b7280;">${club.year.includes('All Years')?'All Years':escapeHtml(club.year.join(', '))}</div>
          <div style="font-size:12px;color:#6b7280;">Where: ${escapeHtml(club.location)} • Who: ${escapeHtml(club.staff)}</div>`;
        const cbWrap=document.createElement('div'); cbWrap.className='club-select-box';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=club.urn;
        cb.checked=selectedClubs.has(club.urn);
        cb.disabled=!(yearFilter.value||selectedClubs.has(club.urn));
        cb.addEventListener('change',e=>{
          if(e.target.checked){selectedClubs.add(club.urn); card.classList.add('club-selected');}
          else{selectedClubs.delete(club.urn); card.classList.remove('club-selected');}
          updatePrintButtons();
        });
        cbWrap.appendChild(cb); card.appendChild(cbWrap);
        clubsList.appendChild(card);
      });
    }

    function updatePrintButtons(){
      if(yearFilter.value){printMyBtn.classList.remove('hidden');} else {printMyBtn.classList.add('hidden');}
      if(selectedClubs.size>0){printPersonalBtn.classList.remove('hidden');} else {printPersonalBtn.classList.add('hidden');}
    }

    // Stub fetch (replace with real CSV fetch)
    clubsData=[{urn:'1',name:'Chess Club',day:'Monday',when:'After School',year:['All Years'],location:'Room A',staff:'Mr X',department:'Maths'}];
    renderClubs(clubsData);

    yearFilter.addEventListener('change',()=>{renderClubs(clubsData);updatePrintButtons();});
    searchInput.addEventListener('input',()=>renderClubs(clubsData));

    // Printing
    function buildGrid(clubs){
      const days=['Monday','Tuesday','Wednesday','Thursday','Friday'];
      const whens=['Before School','Lunchtime','After School'];
      const times={'Before School':'08:00-08:30','Lunchtime':'12:45-13:30','After School':'15:30-16:30'};
      const grid={}; whens.forEach(w=>{grid[w]={}; days.forEach(d=>grid[w][d]=[]);});
      clubs.forEach(c=>{if(grid[c.when]&&grid[c.when][c.day]) grid[c.when][c.day].push(c);});
      return{grid,days,whens,times};
    }

    function createPrintHTML(title,clubs){
      const {grid,days,whens,times}=buildGrid(clubs);
      let html=`<h1>${escapeHtml(title)}</h1><div style="font-style:italic;color:#6b7280;margin-bottom:8px;">Other clubs available to me</div>`;
      html+=`<table style="width:100%;border-collapse:collapse;"><thead><tr><th>When/Day</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
      whens.forEach(w=>{html+=`<tr><th>${w}<div style="font-size:10pt;color:#6b7280;">${times[w]}</div></th>`;
        days.forEach(d=>{const cell=grid[w][d]; if(!cell.length) html+=`<td>—</td>`; else{
          let cHtml=''; cell.forEach(club=>{cHtml+=`<div><strong>${escapeHtml(club.name)}</strong><div style="font-style:italic;color:#6b7280;">All Years</div></div>`;});
          html+=`<td>${cHtml}</td>`;}); html+=`</tr>`;});
      html+=`</tbody></table>`;
      return`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>@page{size:landscape;}th,td{border:1px solid #ccc;padding:6px;}</style></head><body>${html}</body></html>`;
    }

    function printViaIframe(html){const f=document.getElementById('print-iframe');const doc=f.contentDocument||f.contentWindow.document;doc.open();doc.write(html);doc.close();setTimeout(()=>{f.contentWindow.print();},300);}

    printMyBtn.addEventListener('click',()=>{const y=yearFilter.value;const clubs=clubsData.filter(c=>c.year.includes('All Years')||c.year.includes(y));printViaIframe(createPrintHTML('Year '+y+' Timetable',clubs));});
    printPersonalBtn.addEventListener('click',()=>{const clubs=clubsData.filter(c=>selectedClubs.has(c.urn));printViaIframe(createPrintHTML('My Clubs Timetable',clubs));});
  </script>
</body>
</html>

