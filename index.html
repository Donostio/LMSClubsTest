<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LMS Clubs</title>
<link rel="icon" type="image/png" href="lms_logo.png">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  :root{--muted:#6b7280;--red:#ef4444;--black:#000;}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  /* page background stripes (left / right visible behind central white panel) */
  body{
    background-color:#000;
    background-image: repeating-linear-gradient(to right, var(--red), var(--red) 2px, #000 2px, #000 24px);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* central white container */
  .page {
    max-width:1180px;
    margin:28px auto;
    background:#fff;
    border-radius:12px;
    padding:18px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.25);
  }

  header.top {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    background:#fff;
    margin:0 0 12px 0;
  }
  header.top h1{margin:0;font-size:22px;font-weight:700;color:#111;}
  .controls { display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; margin-bottom:12px; }
  .control-column { display:flex; flex-direction:column; gap:8px; min-width:200px; }

  /* Year select is 1/5 width on wide screens, min width to keep usable */
  .year-row { display:flex; align-items:flex-start; gap:12px; }
  select#year-filter { padding:10px;border-radius:10px;border:1px solid #e6e6e6; width:20%; min-width:84px; color:var(--red); font-weight:600; }
  /* ensure option 'All' displays red initially â€” many browsers ignore option color, so we set select color when value empty */
  select#year-filter.filled { color: #111; }

  /* print controls next to select */
  .print-controls { display:flex; align-items:center; gap:8px; margin-top:6px; }

  /* search placed below year column (on next row) - width 1/5 on wide screens */
  input#search-input { padding:10px;border-radius:10px;border:1px solid #e6e6e6; width:20%; min-width:200px; }

  /* cards grid */
  #clubs-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:14px; margin-top:12px; }
  .club-card {
    position:relative;
    background:#fff;
    border:1px solid #e6e6e6;
    border-radius:12px;
    padding:14px;
    color:#111;
    transition: box-shadow .15s ease, transform .12s ease;
  }
  .club-card:hover { transform:translateY(-4px); box-shadow:0 8px 28px rgba(0,0,0,0.06); }
  .club-card .muted { color:var(--muted); }
  .club-select-box { position:absolute; right:12px; bottom:12px; }

  .selected { box-shadow:0 0 0 3px rgba(0,0,0,1), 0 0 0 6px rgba(239,68,68,0.95); border:2px solid rgba(239,68,68,0.9); }

  /* Filter panel (slide-in) */
  .filter-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:60; }
  .filter-panel { position:fixed; right:0; top:0; height:100%; width:360px; max-width:92%; background:#fff; z-index:70; transform:translateX(110%); transition:transform .28s cubic-bezier(.2,.9,.3,1); box-shadow:-20px 20px 60px rgba(0,0,0,0.12); padding:20px; overflow:auto; }
  .filter-panel.open{ transform:translateX(0); }
  .filter-row { margin-bottom:12px; }
  .clear-link { color: #7c3aed; cursor:pointer; font-size:13px; border:none; background:none; padding:0; }

  /* print-specific styles */
  @media print {
    @page { size: landscape; margin:12mm; }
    body { background:#fff; }
    /* hide UI elements */
    #filter-panel, #filter-btn, #search-input, .filter-overlay, #filter-controls { display:none !important; }
    .page * { visibility: hidden; }
    #printable-area, #printable-area * { visibility: visible; }
  }

  /* print table styles used inside generated print HTML (kept compact) */
  /* utility */
  .muted-sm { color:var(--muted); font-style:italic; font-size:90%; line-height:0.95; }
  .small-gap { height:0.25rem; }

  /* responsive */
  @media (max-width:720px){
    input#search-input, select#year-filter { width:100%; }
    .print-controls { margin-top:6px; flex-wrap:wrap; }
  }
</style>
</head>
<body>
  <div id="cat-container" style="position:fixed;z-index:120;pointer-events:none;bottom:0;left:50%;transform:translateX(-50%);display:none;">
    <img id="cat-image" src="" alt="cat" style="width:160px;border-radius:.75rem;display:block;">
  </div>

  <div class="page" role="main">
    <header class="top">
      <h1>Lady Margaret School â€” Clubs 2025-26</h1>
      <div>
        <button id="filter-btn" title="Open filters" style="background:#7c3aed;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;">Filters</button>
      </div>
    </header>

    <section class="controls" aria-label="controls">
      <div class="control-column" style="min-width:260px;">
        <div class="year-row">
          <div>
            <label for="year-filter" style="display:block;font-weight:600;margin-bottom:6px;">Year Group</label>
            <select id="year-filter" aria-label="Year group">
              <option value="">All</option>
              <option value="7">7</option><option value="8">8</option><option value="9">9</option>
              <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
            </select>
          </div>

          <div class="print-controls" id="print-controls" style="margin-left:8px;">
            <!-- content added by JS: either 'Filter by year' text or button(s) -->
            <span id="year-message" style="color:var(--muted);margin-top:8px;">Filter by year</span>
          </div>
        </div>

        <!-- search moved below year group -->
        <div style="margin-top:10px;">
          <label for="search-input" style="display:block;font-weight:600;margin-bottom:6px;">Search</label>
          <input id="search-input" placeholder="Search for a club..." aria-label="Search clubs" />
        </div>
      </div>

      <!-- active filter summary -->
      <div style="flex:1;align-self:flex-end;">
        <div id="active-filters-summary" style="color:var(--muted);font-size:13px;">All clubs shown</div>
      </div>
    </section>

    <!-- main cards area -->
    <main>
      <div id="clubs-list" aria-live="polite"></div>
      <div id="no-results" style="display:none;color:var(--muted);padding:18px;text-align:center;">No clubs found matching your criteria.</div>
    </main>

    <footer style="margin-top:26px;color:var(--muted);font-size:13px;text-align:center;">
      <div>This site is maintained by LMS class reps ðŸš€</div>
      <div style="margin-top:6px;">Feedback: <a href="https://forms.gle/5Gdrj6RPAEXf7jKy8" target="_blank" rel="noopener" style="color:var(--red)">Please share your thoughts</a></div>
    </footer>
  </div>

  <!-- filter panel -->
  <div id="filter-overlay" class="filter-overlay" aria-hidden="true"></div>
  <aside id="filter-panel" class="filter-panel" aria-hidden="true">
    <h2 style="margin-top:0;font-size:18px;">Filters</h2>

    <div class="filter-row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <strong>Day</strong>
        <button id="clear-day" class="clear-link">Clear</button>
      </div>
      <div>
        <label><input type="checkbox" class="day-filter" value="All" checked> All</label><br>
        <label><input type="checkbox" class="day-filter" value="Monday"> Monday</label><br>
        <label><input type="checkbox" class="day-filter" value="Tuesday"> Tuesday</label><br>
        <label><input type="checkbox" class="day-filter" value="Wednesday"> Wednesday</label><br>
        <label><input type="checkbox" class="day-filter" value="Thursday"> Thursday</label><br>
        <label><input type="checkbox" class="day-filter" value="Friday"> Friday</label>
      </div>
    </div>

    <div class="filter-row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <strong>When</strong>
        <button id="clear-when" class="clear-link">Clear</button>
      </div>
      <div>
        <label><input type="checkbox" class="when-filter" value="All" checked> All</label><br>
        <label><input type="checkbox" class="when-filter" value="Before School"> Before School</label><br>
        <label><input type="checkbox" class="when-filter" value="Lunchtime"> Lunchtime</label><br>
        <label><input type="checkbox" class="when-filter" value="After School"> After School</label>
      </div>
    </div>

    <div class="filter-row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <strong>Department</strong>
        <button id="clear-dept" class="clear-link">Clear</button>
      </div>
      <div id="dept-options" style="max-height:160px;overflow:auto;"></div>
    </div>

    <div style="margin-top:auto;">
      <button id="clear-all" style="width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;">Clear All Filters</button>
    </div>
  </aside>

  <iframe id="print-iframe" style="display:none;width:0;height:0;"></iframe>

<script>
/* -------------------------
   Utility & state
   ------------------------- */
const STORAGE_KEY = 'lms_selected_clubs_v2';
let clubsData = [];
const selectedClubs = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

const clubsListEl = document.getElementById('clubs-list');
const yearFilterEl = document.getElementById('year-filter');
const searchInputEl = document.getElementById('search-input');
const printControlsEl = document.getElementById('print-controls');
const yearMessageEl = document.getElementById('year-message');
const filterBtn = document.getElementById('filter-btn');
const filterPanel = document.getElementById('filter-panel');
const filterOverlay = document.getElementById('filter-overlay');

function saveSelections(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify([...selectedClubs])); }catch(e){console.warn('save failed',e);}
}
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* -------------------------
   Cat animation (restored)
   - call showAscendingCatForTesting() in console to test
   ------------------------- */
const catImages = ['images/1C.png','images/2C.png','images/3.png'];
const catContainer = document.getElementById('cat-container');
const catImage = document.getElementById('cat-image');
let catCounter = 0;
function showCatRandom(){
  const idx = Math.floor(Math.random()*catImages.length);
  catImage.src = catImages[idx];
  catContainer.style.display = 'block';
  catContainer.style.opacity = '1';
  // simple pop-up then hide
  catContainer.style.transform = 'translateX(-50%) translateY(0)';
  setTimeout(()=>{ catContainer.style.transform = 'translateX(-50%) translateY(110%); }, 2200);
  setTimeout(()=>{ catContainer.style.display = 'none'; catImage.src=''; }, 3000);
}
function showAscendingCatForTesting(){
  // show larger ascending animation
  catImage.src = catImages[0] || '';
  catContainer.style.display='block';
  catContainer.style.transform='translateX(-50%) translateY(0)';
  setTimeout(()=>{ catContainer.style.transform='translateX(-50%) translateY(110%)'; }, 1800);
  setTimeout(()=>{ catContainer.style.display='none'; catImage.src=''; }, 2600);
}
// small interaction counter to randomly show cats (basic)
let interaction = 0;
let nextShow = 40;
document.addEventListener('click', ()=>{ interaction++; if(interaction >= nextShow){ showCatRandom(); interaction=0; nextShow = 20 + Math.floor(Math.random()*100); }});
document.addEventListener('mousemove', ()=>{ interaction++; if(interaction >= nextShow){ showCatRandom(); interaction=0; nextShow = 20 + Math.floor(Math.random()*100); }});
setTimeout(()=>{ try{ showAscendingCatForTesting(); }catch(e){} }, 600);

/* -------------------------
   CSV fetch & parse
   ------------------------- */
async function fetchClubsCSV(){
  try{
    const res = await fetch('clubs.csv', {cache:'no-store'});
    const text = await res.text();
    const lines = text.trim().split(/\r?\n/).filter(Boolean);
    if(lines.length <= 1){ clubsData = []; renderClubs([]); return; }
    const rows = lines.slice(1);
    clubsData = rows.map(r=>{
      // split CSV respecting quoted commas
      const cols = r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.trim().replace(/^"|"$/g,''));
      const yearRaw = cols[5]||'';
      let yearArr = [];
      if(yearRaw && yearRaw.toLowerCase().includes('all years')) yearArr = ['All Years'];
      else if(yearRaw) yearArr = yearRaw.split(/[,&\/\s]+/).map(x=>x.trim()).filter(Boolean);
      return {
        urn: cols[9] ? String(cols[9]) : (cols[0] + '::' + Math.random().toString(36).slice(2,8)),
        name: cols[0] || '',
        when: cols[1] || '',
        day: cols[2] || '',
        weeks: cols[3] || '',
        time: cols[4] || '',
        yearRaw: yearRaw,
        year: yearArr,
        location: cols[6] || '',
        staff: cols[7] || '',
        department: cols[8] || ''
      };
    });
    populateDeptOptions();
    renderClubs(clubsData);
    initFilterLogic(); // wire filter panel after dept options exist
    updatePrintControls();
  }catch(e){
    console.error('clubs.csv load failed', e);
    clubsListEl.innerHTML = '<div style="padding:12px;background:#fff;border-radius:12px;color:#b91c1c">Error loading clubs.csv â€” check devtools console</div>';
  }
}

/* -------------------------
   Populate department filter options
   ------------------------- */
function populateDeptOptions(){
  const container = document.getElementById('dept-options');
  const depts = [...new Set(clubsData.map(c=>c.department).filter(Boolean))].sort();
  container.innerHTML = depts.map(d=>`<label><input type="checkbox" class="dept-filter" value="${escapeHtml(d)}"> ${escapeHtml(d)}</label><br>`).join('');
}

/* -------------------------
   Filter helpers
   ------------------------- */
function getActiveFilters(){
  const year = yearFilterEl.value;
  const search = (searchInputEl.value||'').trim().toLowerCase();
  const selectedDays = Array.from(document.querySelectorAll('.day-filter:checked')).map(i=>i.value);
  const selectedWhens = Array.from(document.querySelectorAll('.when-filter:checked')).map(i=>i.value);
  const selectedDepts = Array.from(document.querySelectorAll('.dept-filter:checked')).map(i=>i.value);
  return { year, search, selectedDays, selectedWhens, selectedDepts };
}

function clubMatchesFilter(club, f){
  // search across multiple fields, including years combined
  if(f.search){
    const hay = (club.name + ' ' + (club.department||'') + ' ' + (club.location||'') + ' ' + (club.staff||'') + ' ' + (club.year?club.year.join(' '):'')).toLowerCase();
    if(!hay.includes(f.search)) return false;
  }
  if(f.year){
    // club matches if All Years OR includes year
    if(!club.year.includes('All Years') && !club.year.includes(f.year)) return false;
  }
  if(f.selectedDepts.length){
    if(!f.selectedDepts.includes(club.department)) return false;
  }
  if(f.selectedDays.length && !f.selectedDays.includes('All')){
    if(!f.selectedDays.includes(club.day)) return false;
  }
  if(f.selectedWhens.length && !f.selectedWhens.includes('All')){
    if(!f.selectedWhens.includes(club.when)) return false;
  }
  return true;
}

/* -------------------------
   Render club cards
   ------------------------- */
function specialClubNoteHTML(name){
  if(!name) return '';
  const n = name.toLowerCase();
  if(n.includes('lunch club')) return ' <strong>12:45 start</strong>';
  if(n.includes('chamber choir') || n.includes('orchestra')) return ' <strong>16:45 finish</strong>';
  return '';
}

function renderClubs(data){
  const f = getActiveFilters();
  const filtered = data.filter(c => clubMatchesFilter(c, f));
  clubsListEl.innerHTML = '';
  if(filtered.length === 0){
    document.getElementById('no-results').style.display = 'block';
  } else {
    document.getElementById('no-results').style.display = 'none';
  }
  filtered.forEach(club=>{
    const card = document.createElement('div');
    card.className = 'club-card';
    if(selectedClubs.has(club.urn)) card.classList.add('selected');

    // year display: if All Years show 'All Years', else if a specific year is selected prefix 'Years:' in grey
    let yearsText = '';
    if(club.year.includes('All Years')) yearsText = 'All Years';
    else yearsText = club.year.join(', ');
    if(f.year && !club.year.includes('All Years')) {
      yearsText = `<span class="muted">Years:</span> ${escapeHtml(yearsText)}`;
    } else {
      yearsText = escapeHtml(yearsText);
    }

    const specialNote = specialClubNoteHTML(club.name);

    card.innerHTML = `
      <div style="font-weight:700;font-size:15px;color:#111;margin-bottom:8px;">${escapeHtml(club.name)}</div>
      <div style="font-size:13px;color:#111;margin-bottom:6px;">${escapeHtml(club.day)} â€¢ ${escapeHtml(club.when)}</div>
      <div style="font-size:12px;color:#111;margin-bottom:6px;">${yearsText}</div>
      <div style="font-size:12px;color:var(--muted);">Where: <span class="muted">${escapeHtml(club.location)}</span> â€¢ Who: <span class="muted">${escapeHtml(club.staff)}</span>${specialNote}</div>
    `;

    // checkbox (disabled until a year chosen, unless already selected)
    const cbWrap = document.createElement('div');
    cbWrap.className = 'club-select-box';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = club.urn;
    cb.checked = selectedClubs.has(club.urn);
    cb.disabled = !(yearFilterEl.value || selectedClubs.has(club.urn));
    cb.title = cb.disabled ? 'Select a year to enable selection' : 'Select this club';
    cb.addEventListener('change', (e)=>{
      if(e.target.checked){ selectedClubs.add(club.urn); card.classList.add('selected'); }
      else { selectedClubs.delete(club.urn); card.classList.remove('selected'); }
      saveSelections();
      updatePrintControls();
    });
    cbWrap.appendChild(cb);
    card.appendChild(cbWrap);
    clubsListEl.appendChild(card);
  });
}

/* -------------------------
   Print controls logic
   - Single Year-group button appears when a year selected
   - Helper text to the right: "Select clubs below to highlight them on your timetable"
   - When first club selected a second "Print My Selected Clubs" button appears; helper text hidden
   ------------------------- */
function updatePrintControls(){
  printControlsEl.innerHTML = '';
  const year = yearFilterEl.value;
  if(!year){
    yearMessageEl.textContent = 'Filter by year';
    yearMessageEl.style.color = 'var(--muted)';
    printControlsEl.appendChild(yearMessageEl);
    return;
  }

  // Year-group button (always present once a year chosen)
  const btnYear = document.createElement('button');
  btnYear.type = 'button';
  btnYear.textContent = 'Print Year-group Timetable';
  btnYear.style.padding = '8px 12px';
  btnYear.style.borderRadius = '10px';
  btnYear.style.border = 'none';
  btnYear.style.background = 'linear-gradient(90deg,#ef4444,#000)';
  btnYear.style.color = '#fff';
  btnYear.style.fontWeight = '700';
  btnYear.id = 'print-year-btn';
  btnYear.addEventListener('click', ()=>{
    const y = yearFilterEl.value;
    const clubsForYear = clubsData.filter(c => c.year.includes('All Years') || c.year.includes(y));
    // selected within that year vs others
    const selected = clubsForYear.filter(c=>selectedClubs.has(c.urn));
    const others = clubsForYear.filter(c=>!selectedClubs.has(c.urn));
    const title = `Year ${y} Clubs Timetable`;
    const html = createPrintHTML(title, selected, others, { showOtherTitle:false });
    printViaIframe(html);
  });
  printControlsEl.appendChild(btnYear);

  // If no selected clubs -> show helper text to the right
  if(selectedClubs.size === 0){
    const helper = document.createElement('span');
    helper.textContent = 'Select clubs below to highlight them on your timetable';
    helper.style.color = 'var(--muted)';
    helper.style.marginLeft = '8px';
    printControlsEl.appendChild(helper);
  } else {
    // When at least one selected, show Print My Selected Clubs button (same style)
    const btnMy = document.createElement('button');
    btnMy.type = 'button';
    btnMy.textContent = 'Print My Selected Clubs';
    btnMy.style.padding = '8px 12px';
    btnMy.style.borderRadius = '10px';
    btnMy.style.border = 'none';
    btnMy.style.background = 'linear-gradient(90deg,#ef4444,#000)';
    btnMy.style.color = '#fff';
    btnMy.style.fontWeight = '700';
    btnMy.id = 'print-personal-btn';
    btnMy.addEventListener('click', ()=>{
      // personal print: selected clubs placed in their cells; other available clubs (that match the selected year or All Years) appear as grey italic
      const y = yearFilterEl.value;
      // selected clubs across all days/whens (we will only include clubs relevant to the selected year or All Years)
      const selected = clubsData.filter(c => selectedClubs.has(c.urn) && (c.year.includes('All Years') || c.year.includes(y)));
      // others that are relevant to the chosen year but not selected
      const others = clubsData.filter(c => !selectedClubs.has(c.urn) && (c.year.includes('All Years') || c.year.includes(y)));
      const title = 'My selected clubs timetable';
      const html = createPrintHTML(title, selected, others, { showOtherTitle:true });
      printViaIframe(html);
    });
    printControlsEl.appendChild(btnMy);
  }
}

/* -------------------------
   Print HTML generation
   - selected: array of selected clubs (primary)
   - others: array of other clubs (displayed in grey italics)
   - options.showOtherTitle: whether to include the grey italic "Other clubs available to me" under the title (personal print)
   ------------------------- */
function buildGridForPrint(clubs){
  const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
  const whens = ['Before School','Lunchtime','After School'];
  const grid = {};
  whens.forEach(w=>{ grid[w] = {}; days.forEach(d=>grid[w][d] = []); });
  clubs.forEach(c=>{
    const when = c.when || 'After School';
    const day = c.day || '';
    if(grid[when] && grid[when][day]) grid[when][day].push(c);
  });
  return { grid, days, whens };
}
function createPrintHTML(title, selectedArr, othersArr, options){
  options = options || {};
  const combined = (selectedArr || []).concat(othersArr || []);
  const { grid, days, whens } = buildGridForPrint(combined);
  const styles = `
    <style>
      @page { size: landscape; margin: 12mm; }
      body{ font-family: Inter, Arial, sans-serif; color:#000; margin:0; padding:12px; }
      h1{ font-size:18pt; margin:0 0 6px 0; }
      table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:10pt; }
      th,td{ border:1px solid #ddd; padding:6px; vertical-align:top; word-break:break-word; }
      th{ background:#f8fafc; text-align:left; font-weight:700; }
      .club-name{ font-weight:700; display:block; margin-bottom:6px; }
      .other-club{ font-style:italic; color:#6b7280; font-size:90%; line-height:0.95; margin-bottom:4px; display:block; }
      .small-gap{ height:0.25rem; }
    </style>
  `;
  let html = `<div id="printable-area"><h1>${escapeHtml(title)}</h1>`;
  if(options.showOtherTitle){
    html += `<div style="font-style:italic;color:#6b7280;margin-bottom:8px;">Other clubs available to me</div>`;
  }
  html += `<table><thead><tr><th style="width:16%;">When / Day</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
  whens.forEach(w=>{
    html += `<tr><th>${w}<div style="font-size:10pt;color:#6b7280;margin-top:6px;">${w === 'Before School' ? '08:00-08:30' : w === 'Lunchtime' ? '12:45-13:30' : '15:30-16:30'}</div></th>`;
    days.forEach(d=>{
      const cell = grid[w][d] || [];
      if(!cell.length){ html += `<td style="min-height:70px;">â€”</td>`; return; }
      // We'll render selected clubs first (bold), then other clubs (grey italic)
      let cellHtml = '';
      // Selected (from selectedArr)
      cell.forEach(c=>{
        if(selectedArr && selectedArr.find(s=>s.urn === c.urn)){
          // show name bold + years (with 'All Years' or 'Years: ...')
          const ytext = c.year.includes('All Years') ? 'All Years' : ('Years: '+escapeHtml(c.year.join(', ')));
          cellHtml += `<div><span class="club-name">${escapeHtml(c.name)}</span><div style="font-size:10pt;color:#000;">${escapeHtml(ytext)}${specialClubNoteHTML(c.name) ? `<span> ${specialClubNoteHTML(c.name)}</span>` : ''}</div></div><div class="small-gap"></div>`;
        }
      });
      // Others (only if present in othersArr)
      cell.forEach(c=>{
        if(othersArr && othersArr.find(o=>o.urn === c.urn)){
          const ytext = c.year.includes('All Years') ? 'All Years' : ('Years: '+escapeHtml(c.year.join(', ')));
          cellHtml += `<div class="other-club">${escapeHtml(c.name)} (${escapeHtml(ytext)})</div><div style="height:0.125rem"></div>`;
        }
      });
      html += `<td>${cellHtml}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table></div>`;
  return `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(title)}</title>${styles}</head><body>${html}</body></html>`;
}
function printViaIframe(html){
  const iframe = document.getElementById('print-iframe');
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();
  setTimeout(()=>{
    try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ alert('Print failed - please use your browser print command.'); }
  }, 300);
}

/* -------------------------
   Filter panel logic
   - open/close overlay
   - autoprefix toggles for All vs specifics
   - clear buttons
   - filter application
   ------------------------- */
filterBtn.addEventListener('click', ()=>{ filterPanel.classList.add('open'); filterOverlay.style.display='block'; });
filterOverlay.addEventListener('click', ()=>{ filterPanel.classList.remove('open'); filterOverlay.style.display='none'; });
document.getElementById('clear-day').addEventListener('click', ()=>{
  document.querySelectorAll('.day-filter').forEach(cb=>cb.checked = cb.value === 'All');
  applyFiltersAndRender();
});
document.getElementById('clear-when').addEventListener('click', ()=>{
  document.querySelectorAll('.when-filter').forEach(cb=>cb.checked = cb.value === 'All');
  applyFiltersAndRender();
});
document.getElementById('clear-dept').addEventListener('click', ()=>{
  document.querySelectorAll('.dept-filter').forEach(cb=>cb.checked = false);
  applyFiltersAndRender();
});
document.getElementById('clear-all').addEventListener('click', ()=>{
  document.querySelectorAll('.day-filter, .when-filter, .dept-filter').forEach(cb=>cb.checked = false);
  // recheck All
  const dayAll = document.querySelector('.day-filter[value="All"]'); if(dayAll) dayAll.checked = true;
  const whenAll = document.querySelector('.when-filter[value="All"]'); if(whenAll) whenAll.checked = true;
  applyFiltersAndRender();
});

/* toggling behavior for the filter groups */
function initFilterLogic(){
  function wireGroup(selector){
    // after dept options created, this will wire them too
    const boxes = Array.from(document.querySelectorAll(selector));
    boxes.forEach(b=>{
      b.addEventListener('change', ()=>{
        // if checked item is 'All' -> uncheck others
        if(b.value === 'All' && b.checked){
          boxes.filter(x=>x.value !== 'All').forEach(x=>x.checked = false);
        } else if(b.value !== 'All' && b.checked){
          const allBox = boxes.find(x=>x.value === 'All');
          if(allBox) allBox.checked = false;
        }
        // if none checked -> reselect All
        if(!boxes.some(x=>x.checked)){
          const allBox = boxes.find(x=>x.value === 'All');
          if(allBox) allBox.checked = true;
        }
        applyFiltersAndRender();
      });
    });
  }
  // wire day and when (they exist at load) and dept (dynamically created)
  wireGroup('.day-filter');
  wireGroup('.when-filter');
  wireGroup('.dept-filter');
}

/* apply filters from panel + search + year selection */
function applyFiltersAndRender(){
  // re-render cards using current filter selections
  renderClubs(clubsData);
  updateActiveFiltersSummary();
  updatePrintControls();
}

/* update text summary on top */
function updateActiveFiltersSummary(){
  const parts = [];
  const year = yearFilterEl.value; if(year) parts.push(`Year: ${year}`);
  const selectedDays = Array.from(document.querySelectorAll('.day-filter:checked')).map(i=>i.value);
  if(selectedDays.length && !selectedDays.includes('All')) parts.push(`Day: ${selectedDays.join(', ')}`);
  const selectedWhens = Array.from(document.querySelectorAll('.when-filter:checked')).map(i=>i.value);
  if(selectedWhens.length && !selectedWhens.includes('All')) parts.push(`When: ${selectedWhens.join(', ')}`);
  const selectedDepts = Array.from(document.querySelectorAll('.dept-filter:checked')).map(i=>i.value);
  if(selectedDepts.length) parts.push(`Dept: ${selectedDepts.join(', ')}`);
  const search = (searchInputEl.value||'').trim();
  if(search) parts.push(`Search: "${search}"`);
  document.getElementById('active-filters-summary').textContent = parts.length ? parts.join(' | ') : 'All clubs shown';
}

/* -------------------------
   Wire up top-level interactions
   ------------------------- */
// show All option red when select empty; set normal color when filled
function updateYearSelectColor(){
  if(!yearFilterEl.value) { yearFilterEl.style.color = 'var(--red)'; }
  else { yearFilterEl.style.color = '#111'; }
}
yearFilterEl.addEventListener('change', ()=>{
  updateYearSelectColor();
  // re-enable all checkboxes when a year selected
  document.querySelectorAll('#clubs-list input[type=checkbox]').forEach(cb=>{
    cb.disabled = !(yearFilterEl.value || selectedClubs.has(cb.value));
  });
  applyFiltersAndRender();
});
updateYearSelectColor();

searchInputEl.addEventListener('input', ()=>{ applyFiltersAndRender(); });

// when dept options change (they're checkboxes) we need to wire them (they are created after CSV load)
document.addEventListener('change', (e)=>{
  if(e.target && e.target.classList && (e.target.classList.contains('dept-filter'))) {
    applyFiltersAndRender();
  }
});

/* initialize filter panel wiring after dept options are created */
function rewireDeptAndFilterLogic(){
  // run initFilterLogic again to wire newly created dept checkboxes
  initFilterLogic();
}

/* -------------------------
   CSV fetch & init
   ------------------------- */
fetchClubsCSV();

/* ensure dept wiring gets attached after populate */
const deptObserver = new MutationObserver((m)=>{
  // when dept-options children are added, run wiring once
  if(document.getElementById('dept-options').children.length){
    initFilterLogic();
    deptObserver.disconnect();
  }
});
deptObserver.observe(document.getElementById('dept-options'), { childList:true });

/* -------------------------
   Final checks on load: restore checkbox disabled state and UI
   ------------------------- */
window.addEventListener('load', ()=>{
  // ensure checkboxes in cards reflect same enabled/disabled rules
  setTimeout(()=>{ document.querySelectorAll('#clubs-list input[type=checkbox]').forEach(cb=>{ cb.disabled = !(yearFilterEl.value || selectedClubs.has(cb.value)); }); }, 400);
  updatePrintControls();
  updateActiveFiltersSummary();
});
</script>
</body>
</html>
