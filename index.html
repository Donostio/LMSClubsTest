<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LMS Clubs</title>
<link rel="icon" type="image/png" href="lms_logo.png">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  body {
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:#000;
    background-image: repeating-linear-gradient(to right,#ef4444,#ef4444 2px,#000 2px,#000 24px);
  }
  .page {max-width:1180px;margin:28px auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 18px 60px rgba(0,0,0,0.25);}
  header.top {display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  header.top h1{margin:0;font-size:22px;font-weight:700;color:#111;}
  #year-filter{padding:10px;border-radius:10px;border:1px solid #e6e6e6;width:20%;min-width:84px;color:#ef4444;font-weight:600;}
  #year-filter.filled{color:#111;}
  #search-input{padding:10px;border-radius:10px;border:1px solid #e6e6e6;width:20%;min-width:200px;}
  #clubs-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px;}
  .club-card{position:relative;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;color:#111;transition:box-shadow .15s ease,transform .12s ease;}
  .club-card:hover{transform:translateY(-4px);box-shadow:0 8px 28px rgba(0,0,0,0.06);}
  .muted{color:#6b7280;}
  .club-select-box{position:absolute;right:12px;bottom:12px;}
  .selected{box-shadow:0 0 0 3px rgba(0,0,0,1),0 0 0 6px rgba(239,68,68,0.95);border:2px solid rgba(239,68,68,0.9);}
  .filter-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:60;}
  .filter-panel{position:fixed;right:0;top:0;height:100%;width:360px;max-width:92%;background:#fff;z-index:70;transform:translateX(110%);transition:transform .28s;box-shadow:-20px 20px 60px rgba(0,0,0,0.12);padding:20px;overflow:auto;}
  .filter-panel.open{transform:translateX(0);}
  .clear-link{color:#7c3aed;cursor:pointer;font-size:13px;background:none;border:none;padding:0;}
  #cat-container{position:fixed;z-index:120;pointer-events:none;bottom:0;left:50%;transform:translateX(-50%) translateY(110%);transition:transform 1s ease,opacity 1s ease;opacity:0;}
  #cat-container.show{transform:translateX(-50%) translateY(0);opacity:1;}
  #cat-image{width:160px;border-radius:.75rem;display:block;}
  @media print{@page{size:landscape;margin:12mm;}body{background:#fff;}#filter-panel,#filter-btn,#search-input,.filter-overlay{display:none!important;}}
</style>
</head>
<body>
  <!-- Cats -->
  <div id="cat-container"><img id="cat-image" src="" alt="cat"></div>

  <div class="page">
    <header class="top">
      <h1>Lady Margaret School â€” Clubs 2025-26</h1>
      <button id="filter-btn" style="background:#7c3aed;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;">Filters</button>
    </header>

    <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <label for="year-filter" style="font-weight:600;display:block;margin-bottom:6px;">Year Group</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <select id="year-filter">
            <option value="">All</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option>
          </select>
          <div id="print-controls"><span id="year-message" style="color:#6b7280;">Filter by year</span></div>
        </div>
        <div style="margin-top:10px;">
          <label for="search-input" style="font-weight:600;display:block;margin-bottom:6px;">Search</label>
          <input id="search-input" placeholder="Search for a club...">
        </div>
      </div>
      <div style="flex:1;align-self:flex-end;">
        <div id="active-filters-summary" style="color:#6b7280;font-size:13px;">All clubs shown</div>
      </div>
    </div>

    <div id="clubs-list"></div>
    <div id="no-results" style="display:none;color:#6b7280;text-align:center;padding:18px;">No clubs found matching your criteria.</div>

    <footer style="margin-top:26px;text-align:center;color:#6b7280;font-size:13px;">
      <div>This site is maintained by LMS class reps ðŸš€</div>
      <div style="margin-top:6px;">Feedback: <a href="https://forms.gle/5Gdrj6RPAEXf7jKy8" target="_blank" style="color:#ef4444;">Please share your thoughts</a></div>
    </footer>
  </div>

  <!-- Filter panel -->
  <div id="filter-overlay" class="filter-overlay"></div>
  <aside id="filter-panel" class="filter-panel">
    <h2>Filters</h2>
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;"><strong>Day</strong><button id="clear-day" class="clear-link">Clear</button></div>
      <div>
        <label><input type="checkbox" class="day-filter" value="All" checked> All</label><br>
        <label><input type="checkbox" class="day-filter" value="Monday"> Monday</label><br>
        <label><input type="checkbox" class="day-filter" value="Tuesday"> Tuesday</label><br>
        <label><input type="checkbox" class="day-filter" value="Wednesday"> Wednesday</label><br>
        <label><input type="checkbox" class="day-filter" value="Thursday"> Thursday</label><br>
        <label><input type="checkbox" class="day-filter" value="Friday"> Friday</label>
      </div>
    </div>
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;"><strong>When</strong><button id="clear-when" class="clear-link">Clear</button></div>
      <div>
        <label><input type="checkbox" class="when-filter" value="All" checked> All</label><br>
        <label><input type="checkbox" class="when-filter" value="Before School"> Before School</label><br>
        <label><input type="checkbox" class="when-filter" value="Lunchtime"> Lunchtime</label><br>
        <label><input type="checkbox" class="when-filter" value="After School"> After School</label>
      </div>
    </div>
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;"><strong>Department</strong><button id="clear-dept" class="clear-link">Clear</button></div>
      <div id="dept-options"></div>
    </div>
    <div style="margin-top:12px;"><button id="clear-all" style="width:100%;padding:8px;border-radius:8px;">Clear All Filters</button></div>
  </aside>

  <iframe id="print-iframe" style="display:none;"></iframe>

<script>
/* ===== Cats ===== */
const catContainer=document.getElementById('cat-container'),catImage=document.getElementById('cat-image');
const catImages=['images/1C.png','images/2C.png','images/3.png'];
function showAscendingCatForTesting(){catImage.src=catImages[0];catContainer.classList.add('show');setTimeout(()=>catContainer.classList.remove('show'),2000);}
let clicks=0,next=30;document.addEventListener('click',()=>{if(++clicks>=next){catImage.src=catImages[Math.floor(Math.random()*catImages.length)];catContainer.classList.add('show');setTimeout(()=>catContainer.classList.remove('show'),2000);clicks=0;next=20+Math.floor(Math.random()*50);}});

/* ===== State ===== */
let clubsData=[],selectedClubs=new Set(JSON.parse(localStorage.getItem('selclubs')||'[]'));
const clubsList=document.getElementById('clubs-list');const yearFilter=document.getElementById('year-filter');const searchInput=document.getElementById('search-input');const printControls=document.getElementById('print-controls');
function saveSel(){localStorage.setItem('selclubs',JSON.stringify([...selectedClubs]));}
function esc(s){return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

/* ===== Render ===== */
function render(){const term=(searchInput.value||'').toLowerCase();const f={year:yearFilter.value,days:[...document.querySelectorAll('.day-filter:checked')].map(c=>c.value),whens:[...document.querySelectorAll('.when-filter:checked')].map(c=>c.value),depts:[...document.querySelectorAll('.dept-filter:checked')].map(c=>c.value)};
const filtered=clubsData.filter(c=>(!term||(c.name+c.department+c.location+c.staff+c.year.join(' ')).toLowerCase().includes(term))&&(!f.year||(c.year.includes('All Years')||c.year.includes(f.year)))&&(!f.depts.length||f.depts.includes(c.department))&&(!f.days.length||f.days.includes('All')||f.days.includes(c.day))&&(!f.whens.length||f.whens.includes('All')||f.whens.includes(c.when)));
clubsList.innerHTML='';if(!filtered.length){document.getElementById('no-results').style.display='block';return;}document.getElementById('no-results').style.display='none';
filtered.forEach(club=>{const card=document.createElement('div');card.className='club-card';if(selectedClubs.has(club.urn))card.classList.add('selected');let y=club.year.includes('All Years')?'All Years':club.year.join(', ');if(f.year&&!club.year.includes('All Years'))y='<span class=\"muted\">Years:</span> '+esc(y);const note=club.name.toLowerCase().includes('lunch club')?'<strong>12:45 start</strong>':(club.name.toLowerCase().includes('chamber choir')||club.name.toLowerCase().includes('orchestra'))?'<strong>16:45 finish</strong>':'';card.innerHTML=`<div style='font-weight:700;margin-bottom:6px;'>${esc(club.name)}</div><div>${esc(club.day)} â€¢ ${esc(club.when)}</div><div>${y}</div><div class='muted'>Where: ${esc(club.location)} â€¢ Who: ${esc(club.staff)} ${note}</div>`;const cb=document.createElement('input');cb.type='checkbox';cb.value=club.urn;cb.checked=selectedClubs.has(club.urn);cb.disabled=!(yearFilter.value||selectedClubs.has(club.urn));cb.onchange=e=>{if(e.target.checked){selectedClubs.add(club.urn);card.classList.add('selected');}else{selectedClubs.delete(club.urn);card.classList.remove('selected');}saveSel();updatePrint();};const wrap=document.createElement('div');wrap.className='club-select-box';wrap.appendChild(cb);card.appendChild(wrap);clubsList.appendChild(card);});}

/* ===== Print controls ===== */
function updatePrint(){printControls.innerHTML='';if(!yearFilter.value){printControls.innerHTML='<span style=\"color:#6b7280;\">Filter by year</span>';return;}const btn=document.createElement('button');btn.textContent='Print Year-group Timetable';btn.style.cssText='background:linear-gradient(90deg,#ef4444,#000);color:#fff;padding:8px 12px;border:none;border-radius:8px;font-weight:700;';btn.onclick=()=>{const y=yearFilter.value;const sel=clubsData.filter(c=>selectedClubs.has(c.urn)&&(c.year.includes('All Years')||c.year.includes(y)));const others=clubsData.filter(c=>!selectedClubs.has(c.urn)&&(c.year.includes('All Years')||c.year.includes(y)));printViaIframe(printHTML('Year '+y+' Clubs Timetable',sel,others,false));};printControls.appendChild(btn);if(!selectedClubs.size){printControls.insertAdjacentHTML('beforeend','<span style=\"color:#6b7280;margin-left:6px;\">Select clubs below to highlight them on your timetable</span>');}else{const btn2=document.createElement('button');btn2.textContent='Print My Selected Clubs';btn2.style.cssText=btn.style.cssText;btn2.onclick=()=>{const y=yearFilter.value;const sel=clubsData.filter(c=>selectedClubs.has(c.urn)&&(c.year.includes('All Years')||c.year.includes(y)));const others=clubsData.filter(c=>!selectedClubs.has(c.urn)&&(c.year.includes('All Years')||c.year.includes(y)));printViaIframe(printHTML('My selected clubs timetable',sel,others,true));};printControls.appendChild(btn2);}}

/* ===== Print HTML ===== */
function printHTML(title,sel,others,showOther){const days=['Monday','Tuesday','Wednesday','Thursday','Friday'],whens=['Before School','Lunchtime','After School'];let grid={};whens.forEach(w=>{grid[w]={};days.forEach(d=>grid[w][d]=[]);});[...sel,...others].forEach(c=>{if(grid[c.when]&&grid[c.when][c.day])grid[c.when][c.day].push(c);});let html='<h1>'+esc(title)+'</h1>';if(showOther)html+='<div style=\"font-style:italic;color:#6b7280;margin-bottom:6px;\">Other clubs available to me</div>';html+='<table style=\"width:100%;border-collapse:collapse;font-size:10pt;\"><thead><tr><th>When/Day</th>'+days.map(d=>'<th>'+d+'</th>').join('')+'</tr></thead><tbody>';whens.forEach(w=>{html+='<tr><th>'+w+'</th>';days.forEach(d=>{let cell=grid[w][d];if(!cell.length){html+='<td>â€”</td>';return;}let s='',o='';cell.forEach(c=>{if(sel.find(x=>x.urn===c.urn))s+='<div><b>'+esc(c.name)+'</b><div>'+esc(c.year.includes('All Years')?'All Years':'Years: '+c.year.join(', '))+'</div></div>';else if(others.find(x=>x.urn===c.urn))o+='<div style=\"font-size:90%;font-style:italic;color:#6b7280;\">'+esc(c.name)+' ('+esc(c.year.includes('All Years')?'All Years':'Years: '+c.year.join(', '))+')</div>';});html+='<td>'+s+o+'</td>';});html+='</tr>';});html+='</tbody></table>';return'<!doctype html><html><head><meta charset=utf-8><title>'+esc(title)+'</title></head><body>'+html+'</body></html>';}

/* ===== Print helper ===== */
function printViaIframe(html){const f=document.getElementById('print-iframe');const doc=f.contentDocument||f.contentWindow.document;doc.open();doc.write(html);doc.close();setTimeout(()=>f.contentWindow.print(),300);}

/* ===== CSV Fetch ===== */
async function fetchClubs(){const res=await fetch('clubs.csv');const text=await res.text();const rows=text.trim().split('\n').slice(1);clubsData=rows.map(r=>{const cols=r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,''));return{urn:cols[9]||cols[0]+Math.random(),name:cols[0],when:cols[1],day:cols[2],weeks:cols[3],time:cols[4],yearRaw:cols[5],year:(cols[5]&&cols[5].toLowerCase().includes('all years'))?['All Years']:cols[5].split(/[,&/ ]+/).map(x=>x.trim()).filter(Boolean),location:cols[6],staff:cols[7],department:cols[8]};});buildDept();render();updatePrint();}
function buildDept(){const set=new Set(clubsData.map(c=>c.department));const div=document.getElementById('dept-options');div.innerHTML='<label><input type=\"checkbox\" class=\"dept-filter\" value=\"All\" checked> All</label><br>'+[...set].sort().map(d=>'<label><input type=\"checkbox\" class=\"dept-filter\" value=\"'+esc(d)+'\"> '+esc(d)+'</label>').join('<br>');}

/* ===== Filter logic ===== */
function applyFiltersAndRender(){render();}
document.getElementById('clear-day').onclick=()=>{document.querySelectorAll('.day-filter').forEach(c=>c.checked=c.value==='All');applyFiltersAndRender();};
document.getElementById('clear-when').onclick=()=>{document.querySelectorAll('.when-filter').forEach(c=>c.checked=c.value==='All');applyFiltersAndRender();};
document.getElementById('clear-dept').onclick=()=>{document.querySelectorAll('.dept-filter').forEach(c=>c.checked=c.value==='All');applyFiltersAndRender();};
document.getElementById('clear-all').onclick=()=>{['.day-filter','.when-filter','.dept-filter'].forEach(sel=>document.querySelectorAll(sel).forEach(c=>c.checked=c.value==='All'));applyFiltersAndRender();};
function toggleAllLogic(sel){document.querySelectorAll(sel).forEach(c=>c.onchange=e=>{if(c.value==='All'&&c.checked){document.querySelectorAll(sel).forEach(x=>{if(x!==c)x.checked=false;});}else if(c.value!=='All'&&c.checked){document.querySelector(sel+'[value=\"All\"]').checked=false;}});}
toggleAllLogic('.day-filter');toggleAllLogic('.when-filter');toggleAllLogic('.dept-filter');

/* ===== Events ===== */
yearFilter.onchange=()=>{yearFilter.classList.toggle('filled',!!yearFilter.value);render();updatePrint();};
searchInput.oninput=()=>render();
document.getElementById('filter-btn').onclick=()=>{document.getElementById('filter-panel').classList.add('open');document.getElementById('filter-overlay').style.display='block';};
document.getElementById('filter-overlay').onclick=()=>{document.getElementById('filter-panel').classList.remove('open');document.getElementById('filter-overlay').style.display='none';};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('filter-panel').classList.remove('open');document.getElementById('filter-overlay').style.display='none';}});

/* ===== Init ===== */
fetchClubs();
</script>
</body>
</html>

